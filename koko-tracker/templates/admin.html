{% extends "base.html" %}
{% block title %}Admin ‚Äì Balance Tracker{% endblock %}
{% block content %}

<div class="flex items-center justify-between mb-6 flex-wrap gap-3">
    <div>
        <h1 class="text-xl font-bold text-white">‚öôÔ∏è Admin</h1>
        <p class="text-slate-500 text-sm mt-0.5">{{ users|length }} users ¬∑ {{ cards|length }} active cards</p>
    </div>
    <a href="/dashboard" class="text-slate-500 hover:text-white text-sm transition">‚Üê Dashboard</a>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}{% for cat, msg in messages %}
<div class="mb-4 px-4 py-2.5 rounded-xl text-sm {% if cat == 'success' %}bg-green-900/30 border border-green-700 text-green-300{% else %}bg-red-900/30 border border-red-700 text-red-300{% endif %}">{{ msg }}</div>
{% endfor %}{% endif %}{% endwith %}

<!-- Users -->
<div class="card rounded-2xl p-5 mb-5">
    <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4">üë• Users</h2>
    <div class="space-y-3">
    {% for u in users %}
    {% set is_root = (u.id == 1) or (u.username == admin_username) %}
    {% set st = tz_statuses.get(u.id, 'disconnected') %}
    {% set discord_only = u.discord_id and not u.password_hash %}
    {% set user_cards = cards | selectattr('username', 'equalto', u.username) | list %}
    {% set koko_count = user_cards | selectattr('card_type', 'equalto', 'koko') | list | length %}
    {% set tz_count   = user_cards | selectattr('card_type', 'equalto', 'timezone') | list | length %}
    <div class="bg-slate-800/40 rounded-xl p-4 border border-slate-700/50">
        <div class="flex items-start justify-between gap-3 flex-wrap">
            <div class="flex items-center gap-3 flex-wrap">
                <div>
                    <div class="flex items-center gap-2 mb-1 flex-wrap">
                        <span class="font-medium text-white">{{ u.username }}</span>
                        {% if is_root %}<span class="text-xs text-slate-600 border border-slate-700 px-1.5 py-0.5 rounded">root</span>{% endif %}
                        {% if u.is_admin %}<span class="text-xs bg-indigo-900/50 text-indigo-300 border border-indigo-800 px-2 py-0.5 rounded-full">Admin</span>{% endif %}
                        {% if discord_only %}<span class="text-xs bg-[#5865F2]/20 text-[#7289da] border border-[#5865F2]/40 px-2 py-0.5 rounded-full">Discord-only</span>{% endif %}
                    </div>
                    <div class="flex items-center gap-3 text-xs text-slate-500 flex-wrap">
                        {# Timezone status #}
                        <span class="{% if st == 'connected' %}text-green-400{% elif st in ['error','stale','needs_reconnect'] %}text-red-400{% endif %}">
                            TZ: {{ st }}
                        </span>
                        {# Discord ‚Äî show username if linked #}
                        {% if u.discord_id %}
                        <span class="flex items-center gap-1">
                            <svg class="w-3 h-3 shrink-0" viewBox="0 0 24 24" fill="#7289da"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057.102 18.1.127 18.14.163 18.163a19.944 19.944 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.175 13.175 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/></svg>
                            <span class="text-[#7289da]">{{ u.username if discord_only else u.discord_id }}</span>
                        </span>
                        {% else %}
                        <span class="text-slate-600">No Discord</span>
                        {% endif %}
                        {# Cards summary #}
                        {% if koko_count or tz_count %}
                        <span class="text-slate-500">
                            {% if koko_count %}<span class="text-purple-400">{{ koko_count }}üéÆ</span>{% endif %}
                            {% if tz_count %}<span class="text-yellow-400 ml-1">{{ tz_count }}üïπÔ∏è</span>{% endif %}
                        </span>
                        {% else %}
                        <span class="text-slate-700">No cards</span>
                        {% endif %}
                        {# Email #}
                        {% if u.email %}<span class="text-slate-600 truncate max-w-[160px]" title="{{ u.email }}">‚úâ {{ u.email }}</span>{% endif %}
                        {# Join date #}
                        <span>{{ u.created_at[:10] }}</span>
                    </div>
                </div>

                <!-- Leaderboard opt-in toggle -->
                <form method="POST" action="/admin/users/{{ u.id }}/leaderboard" class="flex items-center gap-2">
                    <input type="hidden" name="leaderboard_opt_in" value="{{ '0' if u.leaderboard_opt_in else '1' }}">
                    <button class="text-xs px-2.5 py-1 rounded-lg border transition
                        {% if u.leaderboard_opt_in %}bg-green-900/30 text-green-400 border-green-900 hover:bg-slate-800{% else %}border-slate-700 text-slate-500 hover:border-green-900 hover:text-green-400{% endif %}">
                        üèÜ {{ 'LB: On' if u.leaderboard_opt_in else 'LB: Off' }}
                    </button>
                </form>
            </div>

            <!-- Actions -->
            <div class="flex items-center gap-2 flex-wrap">
                <!-- Rename -->
                <button onclick="toggleRename({{ u.id }})" class="text-xs text-slate-400 hover:text-white px-2 py-1 border border-slate-700 rounded-lg transition">‚úèÔ∏è Rename</button>

                <!-- Admin toggle -->
                {% if not u.is_admin %}
                <form method="POST" action="/admin/make-admin/{{ u.id }}">
                    <button class="text-xs text-indigo-400 px-2 py-1 border border-indigo-900 rounded-lg hover:bg-indigo-900/30 transition">+ Admin</button>
                </form>
                {% elif not is_root %}
                <form method="POST" action="/admin/remove-admin/{{ u.id }}" onsubmit="return confirm('Remove admin from {{ u.username }}?')">
                    <button class="text-xs text-orange-400 px-2 py-1 border border-orange-900 rounded-lg hover:bg-orange-900/20 transition">‚àí Admin</button>
                </form>
                {% endif %}

                <!-- Delete user -->
                {% if not is_root and u.id != current_user.id %}
                <form method="POST" action="/admin/users/{{ u.id }}/delete" onsubmit="return confirm('Delete {{ u.username }}? This cannot be undone.')">
                    <button class="text-xs text-red-400 px-2 py-1 border border-red-900 rounded-lg hover:bg-red-900/20 transition">üóë Delete</button>
                </form>
                {% endif %}
            </div>
        </div>

        <!-- Rename form (hidden) -->
        <form method="POST" action="/admin/users/{{ u.id }}/rename" id="rename-form-{{ u.id }}" class="hidden mt-3 flex items-center gap-2">
            <input name="new_username" type="text" value="{{ u.username }}"
                class="input-field flex-1 px-3 py-1.5 rounded-lg text-sm" placeholder="New username">
            <button type="submit" class="text-xs text-white btn-primary px-3 py-1.5 rounded-lg">Save</button>
            <button type="button" onclick="toggleRename({{ u.id }})" class="text-xs text-slate-500 px-2 py-1.5">Cancel</button>
        </form>
    </div>
    {% endfor %}
    </div>
</div>

<!-- All Cards -->
<div class="card rounded-2xl p-5 mb-5">
    <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4">üÉè All Cards</h2>
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead>
                <tr class="text-xs text-slate-500 uppercase tracking-wider border-b border-slate-800">
                    <th class="text-left pb-2 pr-3">User</th>
                    <th class="text-left pb-2 pr-3">Type</th>
                    <th class="text-left pb-2 pr-3">Label</th>
                    <th class="text-left pb-2 pr-3">Balance</th>
                    <th class="text-left pb-2 pr-3">Bonus</th>
                    <th class="text-left pb-2 pr-3">Points</th>
                    <th class="text-left pb-2 pr-3">Poll</th>
                    <th class="text-left pb-2 pr-3">Updated</th>
                    <th class="text-left pb-2">Leaderboard</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-800/50">
            {% for card in cards %}
            <tr class="text-slate-300 hover:bg-slate-800/20">
                <td class="py-2 pr-3 text-xs font-medium text-white">{{ card.username }}</td>
                <td class="py-2 pr-3">
                    <span class="text-xs px-1.5 py-0.5 rounded {% if card.card_type == 'timezone' %}bg-yellow-900/40 text-yellow-400{% else %}bg-purple-900/40 text-purple-400{% endif %}">
                        {{ card.card_type }}
                    </span>
                    {% if card.tier %}<span class="text-xs text-slate-500 ml-1">{{ card.tier }}</span>{% endif %}
                </td>
                <td class="py-2 pr-3 text-sm text-slate-300">{{ card.card_label or card.card_number }}</td>
                <td class="py-2 pr-3 text-green-400 text-xs font-medium">${{ "%.2f"|format(card.cash_balance or 0) }}</td>
                <td class="py-2 pr-3 text-yellow-400 text-xs">${{ "%.2f"|format(card.cash_bonus or 0) }}</td>
                <td class="py-2 pr-3 text-orange-400 text-xs">{{ card.points or 0 }}</td>
                <td class="py-2 pr-3 text-slate-500 text-xs">{{ card.poll_interval or 60 }}s</td>
                <td class="py-2 pr-3 text-slate-500 text-xs">{{ card.last_updated[:16] if card.last_updated else 'Never' }}</td>
                <td class="py-2">
                    <form method="POST" action="/admin/cards/{{ card.id }}/leaderboard">
                        <input type="hidden" name="leaderboard_public" value="{{ '0' if card.leaderboard_public else '1' }}">
                        <button class="text-xs px-2 py-1 rounded-lg border transition
                            {% if card.leaderboard_public %}bg-green-900/30 text-green-400 border-green-900{% else %}border-slate-700 text-slate-600 hover:text-green-400 hover:border-green-900{% endif %}">
                            {{ '‚úì Public' if card.leaderboard_public else '‚Äî Private' }}
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Timezone Sessions -->
{% if tz_sessions %}
<div class="card rounded-2xl p-5">
    <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4">üïπÔ∏è Timezone Sessions</h2>
    <div class="space-y-2">
    {% for ts in tz_sessions %}
    {% set st = tz_statuses.get(ts.user_id, 'disconnected') %}
    <div class="bg-slate-800/40 rounded-xl p-3.5 flex items-start justify-between gap-4 flex-wrap">
        <div>
            <div class="flex items-center gap-2 mb-1">
                <span class="font-medium text-white text-sm">{{ ts.username }}</span>
                <span class="text-xs px-2 py-0.5 rounded-full
                    {% if st == 'connected' %}bg-green-900/40 text-green-400
                    {% elif st in ['stale','error','needs_reconnect'] %}bg-red-900/40 text-red-400
                    {% else %}bg-slate-700 text-slate-400{% endif %}">{{ st }}</span>
            </div>
            <div class="text-xs text-slate-500">
                Token: <span class="text-slate-400">{{ ts.token_expires_at or '?' }}</span> ¬∑
                Last poll: <span class="{% if ts.last_poll_status == 'ok' %}text-green-400{% elif ts.last_poll_status %}text-red-400{% else %}text-slate-400{% endif %}">
                    {{ ts.last_poll_at or 'Never' }}{% if ts.last_poll_status %} ({{ ts.last_poll_status }}){% endif %}
                </span>
            </div>
        </div>
        <div class="flex flex-col gap-1 items-end shrink-0">
        {% if st == 'needs_reconnect' %}
        <a href="/timezone/start" target="_blank"
            class="text-xs text-red-300 bg-red-900/20 border border-red-900 hover:bg-red-900/40 rounded-lg px-2 py-1 transition">
            ‚ö†Ô∏è Reconnect Required
        </a>
        {% elif st in ['stale','error'] %}
        <button onclick="tzReauth({{ ts.user_id }}, this)"
            class="text-xs text-red-300 bg-red-900/20 border border-red-900 hover:bg-red-900/40 rounded-lg px-2 py-1 transition">
            ‚ö†Ô∏è {{ 'Error' if st == 'error' else 'Stale' }} ‚Äî üîÑ Refresh Token
        </button>
        {% else %}
        <button onclick="tzReauth({{ ts.user_id }}, this)"
            class="text-xs text-slate-600 hover:text-slate-400 border border-slate-700 hover:border-slate-600 rounded-lg px-2 py-1 transition">
            üîÑ Refresh Token
        </button>
        {% endif %}
        </div>
    </div>
    {% endfor %}
    </div>
</div>
{% endif %}


<!-- Koko Quiet Hours -->
<div class="card rounded-2xl p-5 mt-5">
    <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
        <div>
            <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">üåô Koko Quiet Hours</h2>
            <p class="text-xs text-slate-600 mt-0.5">Stop all Koko card polling during overnight hours (UTC)</p>
        </div>
        <div id="quiet-status-badge" class="text-xs px-2.5 py-1 rounded-full border
            {% if quiet_cfg.koko_quiet_enabled == '1' %}bg-indigo-900/30 text-indigo-300 border-indigo-800{% else %}bg-slate-800 text-slate-500 border-slate-700{% endif %}">
            {% if quiet_cfg.koko_quiet_enabled == '1' %}‚óè Active ‚Äî {{ quiet_cfg.koko_quiet_start }}:00‚Äì{{ quiet_cfg.koko_quiet_end }}:00 UTC{% else %}‚óã Off{% endif %}
        </div>
    </div>
    <div class="space-y-3">
        <div class="flex items-center gap-4 flex-wrap">
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="quiet-enabled" {% if quiet_cfg.koko_quiet_enabled == '1' %}checked{% endif %}
                    class="rounded border-slate-600 bg-slate-800 text-indigo-500 focus:ring-indigo-500">
                <span class="text-sm text-slate-300">Enable quiet hours</span>
            </label>
            <div class="flex items-center gap-2">
                <label class="text-xs text-slate-500">From</label>
                <select id="quiet-start" class="input-field text-xs px-2 py-1.5 rounded-lg w-20">
                    {% for h in range(24) %}
                    <option value="{{ h }}" {% if quiet_cfg.koko_quiet_start == h|string %}selected{% endif %}>{{ '%02d'|format(h) }}:00</option>
                    {% endfor %}
                </select>
                <label class="text-xs text-slate-500">to</label>
                <select id="quiet-end" class="input-field text-xs px-2 py-1.5 rounded-lg w-20">
                    {% for h in range(24) %}
                    <option value="{{ h }}" {% if quiet_cfg.koko_quiet_end == h|string %}selected{% endif %}>{{ '%02d'|format(h) }}:00</option>
                    {% endfor %}
                </select>
                <span class="text-xs text-slate-600">UTC</span>
            </div>
        </div>
        <div class="flex justify-end">
            <button id="quiet-save-btn" onclick="saveQuietHours()"
                class="text-xs btn-primary px-4 py-1.5 rounded-lg text-white transition">üíæ Save</button>
        </div>
    </div>
</div>

<!-- Admin Webhook Monitor -->
<div class="card rounded-2xl p-5 mt-5">
    <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
        <div>
            <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">üì° Admin Webhook Monitor</h2>
            <p class="text-xs text-slate-600 mt-0.5">Ping a Discord webhook on card balance updates across all users</p>
        </div>
        <div id="wh-status-badge" class="text-xs px-2.5 py-1 rounded-full border
            {% if admin_webhook and admin_webhook.enabled and admin_webhook.mode != 'off' %}
                bg-green-900/30 text-green-400 border-green-800
            {% else %}
                bg-slate-800 text-slate-500 border-slate-700
            {% endif %}">
            {% if admin_webhook and admin_webhook.enabled and admin_webhook.mode != 'off' %}
                ‚óè Active ‚Äî {{ {'on':'Live','5m':'Every 5m','10m':'Every 10m','30m':'Every 30m','1h':'Hourly','1d':'Daily'}.get(admin_webhook.mode, admin_webhook.mode) }}
            {% else %}
                ‚óã Off
            {% endif %}
        </div>
    </div>

    <!-- URL + controls row -->
    <div class="space-y-3">
        <div class="flex gap-2 flex-wrap items-end">
            <div class="flex-1 min-w-0">
                <label class="text-xs text-slate-500 mb-1 block">Webhook URL</label>
                <input id="wh-url" type="url"
                    value="{{ admin_webhook.webhook_url or '' if admin_webhook else '' }}"
                    placeholder="https://discord.com/api/webhooks/..."
                    class="input-field w-full px-3 py-2 rounded-lg text-sm font-mono">
            </div>
            <button onclick="whTest()"
                class="text-xs text-slate-400 hover:text-white border border-slate-700 hover:border-slate-500 rounded-lg px-3 py-2 transition shrink-0">
                üß™ Test
            </button>
        </div>

        <!-- Mode selector -->
        <div>
            <label class="text-xs text-slate-500 mb-1.5 block">Fire mode</label>
            <div class="flex flex-wrap gap-2">
                {% for val, lbl in [('off','Off'),('on','Every update'),('5m','Every 5 min'),('10m','Every 10 min'),('30m','Every 30 min'),('1h','Hourly'),('1d','Daily')] %}
                <button onclick="whSetMode('{{ val }}')"
                    id="wh-mode-{{ val }}"
                    class="wh-mode-btn text-xs px-3 py-1.5 rounded-lg border transition
                        {% if admin_webhook and admin_webhook.mode == val %}
                            {% if val == 'off' %}bg-slate-700 text-white border-slate-600
                            {% else %}bg-indigo-600 text-white border-indigo-500{% endif %}
                        {% else %}border-slate-700 text-slate-500 hover:border-slate-500 hover:text-slate-300{% endif %}">
                    {{ lbl }}
                </button>
                {% endfor %}
            </div>
            <p class="text-xs text-slate-600 mt-1.5">
                <strong class="text-slate-500">Every update:</strong> fires on each card poll that returns data.
                <strong class="text-slate-500">Timer modes:</strong> batches into one ping per interval (useful to avoid spam).
            </p>
        </div>

        <!-- Save button + last fired -->
        <div class="flex items-center justify-between gap-3 flex-wrap pt-1">
            <div class="text-xs text-slate-600">
                {% if admin_webhook and admin_webhook.last_fired_at %}
                    Last fired: <span class="text-slate-500">{{ admin_webhook.last_fired_at[:16] }}</span>
                {% else %}
                    Never fired
                {% endif %}
            </div>
            <button id="wh-save-btn" onclick="whSave()"
                class="text-xs btn-primary px-4 py-1.5 rounded-lg text-white transition">
                üíæ Save
            </button>
        </div>
    </div>

    <!-- Recent fires feed (live, last 20) -->
    <div class="mt-4 border-t border-slate-800 pt-4">
        <div class="flex items-center justify-between mb-2">
            <span class="text-xs text-slate-500 font-medium">Recent webhook fires</span>
            <span id="wh-feed-count" class="text-xs text-slate-600">‚Äî</span>
        </div>
        <div id="wh-feed" class="space-y-1.5 max-h-64 overflow-y-auto">
            <div class="text-xs text-slate-600 text-center py-4">No fires yet this session</div>
        </div>
    </div>
</div>

<!-- Console Log -->
<div class="card rounded-2xl p-5 mt-6">
    <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">üñ•Ô∏è Console Log</h2>
        <div class="flex items-center gap-2">
            <input id="log-filter" type="text" placeholder="Filter logs..."
                class="input-field text-xs px-3 py-1.5 rounded-lg w-40"
                oninput="filterLogs()">
            <label class="flex items-center gap-1.5 text-xs text-slate-500 cursor-pointer">
                <input type="checkbox" id="log-autoscroll" checked class="rounded"> Auto-scroll
            </label>
            <label class="flex items-center gap-1.5 text-xs text-slate-500 cursor-pointer">
                <input type="checkbox" id="log-autorefresh" checked class="rounded"> Live
            </label>
            <button onclick="clearLogDisplay()" class="text-xs text-slate-600 hover:text-slate-400 px-2 py-1 border border-slate-700 rounded-lg">Clear</button>
        </div>
    </div>
    <div id="log-console"
        class="bg-slate-950 rounded-xl p-3 font-mono text-xs overflow-y-auto space-y-0.5"
        style="height: 340px;">
        <div class="text-slate-600">Loading logs...</div>
    </div>
</div>

<script>
let _logLines = [];
let _logRefreshInterval = null;
let _logSeen = 0;

const LEVEL_STYLES = {
    'ERROR':   'text-red-400',
    'WARNING': 'text-yellow-400',
    'INFO':    'text-slate-300',
    'DEBUG':   'text-slate-500',
};

function renderLogs() {
    const filter = (document.getElementById('log-filter').value || '').toLowerCase();
    const console_ = document.getElementById('log-console');
    const autoscroll = document.getElementById('log-autoscroll').checked;

    const filtered = filter
        ? _logLines.filter(l => l.msg.toLowerCase().includes(filter) || l.level.toLowerCase().includes(filter))
        : _logLines;

    console_.innerHTML = filtered.length === 0
        ? '<div class="text-slate-600">No logs yet.</div>'
        : filtered.map(l => {
            const cls = LEVEL_STYLES[l.level] || 'text-slate-400';
            const lvl = l.level === 'ERROR' ? `<span class="text-red-500 font-bold">[ERR]</span>` :
                        l.level === 'WARNING' ? `<span class="text-yellow-500">[WRN]</span>` : '';
            // Colour-code known prefixes
            const msg = l.msg
                .replace(/\[Poller\]/g, '<span class="text-blue-400">[Poller]</span>')
                .replace(/\[Timezone\]/g, '<span class="text-purple-400">[Timezone]</span>')
                .replace(/\[Startup\]/g, '<span class="text-cyan-400">[Startup]</span>')
                .replace(/\[Reauth\]/g, '<span class="text-yellow-400">[Reauth]</span>')
                .replace(/\[Token watcher\]/g, '<span class="text-yellow-400">[Token watcher]</span>')
                .replace(/\[Bot\]/g, '<span class="text-indigo-400">[Bot]</span>')
                .replace(/\[Discord\]/g, '<span class="text-indigo-400">[Discord]</span>')
                .replace(/\[Mail\]/g, '<span class="text-pink-400">[Mail]</span>')
                .replace(/HTTP 200/g, '<span class="text-green-500">HTTP 200</span>')
                .replace(/HTTP [45]\d\d/g, m => `<span class="text-red-400">${m}</span>`)
                .replace(/SUCCESS/g, '<span class="text-green-400 font-bold">SUCCESS</span>');
            return `<div class="flex gap-2 leading-5 hover:bg-slate-900/50 px-1 rounded">
                <span class="text-slate-600 shrink-0 w-36">${l.ts}</span>
                ${lvl}
                <span class="${cls} break-all">${msg}</span>
            </div>`;
        }).join('');

    if (autoscroll) console_.scrollTop = console_.scrollHeight;
}

function filterLogs() { renderLogs(); }

function clearLogDisplay() {
    _logLines = [];
    _logSeen = 0;
    document.getElementById('log-console').innerHTML = '<div class="text-slate-600">Cleared.</div>';
}

async function fetchLogs() {
    try {
        const r = await fetch('/admin/logs');
        const d = await r.json();
        if (d.lines && d.lines.length !== _logSeen) {
            _logLines = d.lines;
            _logSeen = d.lines.length;
            renderLogs();
        }
    } catch(e) {
        document.getElementById('log-console').innerHTML = '<div class="text-red-400">Failed to fetch logs.</div>';
    }
}

// Auto-refresh toggle
document.getElementById('log-autorefresh').addEventListener('change', function() {
    if (this.checked) {
        _logRefreshInterval = setInterval(fetchLogs, 2000);
    } else {
        clearInterval(_logRefreshInterval);
    }
});

// Initial load + start live refresh
fetchLogs();
_logRefreshInterval = setInterval(fetchLogs, 2000);
</script>

<script>
async function tzReauth(userId, btn) {
    const orig = btn.textContent;
    btn.textContent = '‚ü≥ Refreshing...'; btn.disabled = true;
    try {
        const r = await fetch('/api/timezone/reauth', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({user_id: userId})
        });
        const d = await r.json();
        if (d.success) {
            btn.textContent = '‚úÖ Refreshed!';
            btn.className = btn.className.replace(/text-red-\w+/g, 'text-green-400').replace(/border-red-\w+/g, 'border-green-700').replace(/bg-red-\w+\/\w+/g, '');
            setTimeout(() => location.reload(), 1500);
        } else if (d.needs_reconnect) {
            btn.textContent = '‚ö†Ô∏è Needs reconnect';
            btn.className = btn.className;
            setTimeout(() => location.reload(), 2000);
        } else {
            btn.textContent = '‚ùå ' + (d.error || 'Failed');
            setTimeout(() => { btn.textContent = orig; btn.disabled = false; }, 3000);
        }
    } catch(e) { btn.textContent = orig; btn.disabled = false; }
}

function toggleRename(uid) {
    const f = document.getElementById('rename-form-' + uid);
    f.classList.toggle('hidden');
    if (!f.classList.contains('hidden')) f.querySelector('input').focus();
}

// ‚îÄ‚îÄ Admin Webhook ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _whMode = '{{ admin_webhook.mode if admin_webhook else "off" }}';
let _whFires = [];  // in-memory log of fires this session

function whSetMode(mode) {
    _whMode = mode;
    document.querySelectorAll('.wh-mode-btn').forEach(btn => {
        const isSelected = btn.id === 'wh-mode-' + mode;
        if (isSelected) {
            btn.className = btn.className.replace(/border-slate-700|text-slate-500|hover:\S+/g, '').trim();
            btn.classList.add(...(mode === 'off'
                ? ['bg-slate-700','text-white','border-slate-600']
                : ['bg-indigo-600','text-white','border-indigo-500']));
        } else {
            btn.className = 'wh-mode-btn text-xs px-3 py-1.5 rounded-lg border transition border-slate-700 text-slate-500 hover:border-slate-500 hover:text-slate-300';
        }
    });
}

async function whSave() {
    const btn  = document.getElementById('wh-save-btn');
    const url  = document.getElementById('wh-url').value.trim();
    const orig = btn.textContent;
    btn.textContent = '‚ü≥ Saving...'; btn.disabled = true;
    try {
        const r = await fetch('/admin/webhook', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({webhook_url: url, mode: _whMode})
        });
        const d = await r.json();
        if (d.success) {
            btn.textContent = '‚úÖ Saved!';
            const badge = document.getElementById('wh-status-badge');
            const modeLabels = {on:'Live','5m':'Every 5m','10m':'Every 10m','30m':'Every 30m','1h':'Hourly','1d':'Daily'};
            if (d.enabled) {
                badge.className = badge.className.replace(/bg-slate-800|text-slate-500|border-slate-700/g,'').trim();
                badge.classList.add('bg-green-900/30','text-green-400','border-green-800');
                badge.textContent = `‚óè Active ‚Äî ${modeLabels[d.mode] || d.mode}`;
            } else {
                badge.className = badge.className.replace(/bg-green-\S+|text-green-\S+|border-green-\S+/g,'').trim();
                badge.classList.add('bg-slate-800','text-slate-500','border-slate-700');
                badge.textContent = '‚óã Off';
            }
        } else {
            btn.textContent = '‚ùå ' + (d.error || 'Error');
        }
        setTimeout(() => { btn.textContent = orig; btn.disabled = false; }, 2500);
    } catch(e) {
        btn.textContent = '‚ùå Network error'; btn.disabled = false;
        setTimeout(() => { btn.textContent = orig; btn.disabled = false; }, 2500);
    }
}

async function whTest() {
    const url = document.getElementById('wh-url').value.trim();
    if (!url) { alert('Enter a webhook URL first'); return; }
    const btn = event.target;
    const orig = btn.textContent;
    btn.textContent = '‚ü≥ Sending...'; btn.disabled = true;
    try {
        const r = await fetch('/admin/webhook/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({webhook_url: url})
        });
        const d = await r.json();
        btn.textContent = d.success ? '‚úÖ Sent!' : '‚ùå ' + (d.error || 'Failed');
        if (d.success) whAddFire({type:'test', label:'Test message', username:'admin', card_type:'‚Äî', ts: new Date().toISOString()});
    } catch(e) { btn.textContent = '‚ùå Error'; }
    setTimeout(() => { btn.textContent = orig; btn.disabled = false; }, 3000);
}

function whAddFire(entry) {
    _whFires.unshift(entry);
    if (_whFires.length > 20) _whFires = _whFires.splice(0, 20);
    whRenderFeed();
}

function whRenderFeed() {
    const el = document.getElementById('wh-feed');
    const cnt = document.getElementById('wh-feed-count');
    cnt.textContent = _whFires.length ? `${_whFires.length} fire${_whFires.length>1?'s':''} this session` : '‚Äî';
    if (!_whFires.length) {
        el.innerHTML = '<div class="text-xs text-slate-600 text-center py-4">No fires yet this session</div>';
        return;
    }
    const typeIcon = t => t === 'timezone' ? 'üü°' : t === 'test' ? 'üîî' : 'üü£';
    el.innerHTML = _whFires.map(f => {
        const ts = f.ts ? f.ts.replace('T',' ').slice(0,16) : '';
        const change = f.change ? `<span class="${f.change.startsWith('+') ? 'text-green-400' : 'text-red-400'} font-mono ml-1">${f.change}</span>` : '';
        return `<div class="flex items-center gap-2 bg-slate-800/40 rounded-lg px-3 py-2 text-xs">
            <span class="shrink-0">${typeIcon(f.card_type)}</span>
            <span class="text-slate-400 font-medium shrink-0">${f.username || '‚Äî'}</span>
            <span class="text-slate-600 shrink-0">${f.card_type || '‚Äî'}</span>
            <span class="text-white truncate flex-1">${f.label || f.card_name || '‚Äî'}</span>
            ${change}
            <span class="text-slate-600 shrink-0 tabular-nums">${ts}</span>
        </div>`;
    }).join('');
}

// Poll log to capture admin webhook fires via log scanning
// We piggyback on the existing log feed ‚Äî when a [AdminWebhook] line appears, parse it
const _origRenderLogs = typeof renderLogs === 'function' ? renderLogs : null;
let _lastWhLogSeen = 0;
function checkLogsForWebhookFires() {
    if (!_logLines) return;
    const wh = _logLines.filter((l, i) => i >= _lastWhLogSeen && l.msg && l.msg.includes('[AdminWebhook] Fired'));
    wh.forEach(l => {
        // Parse: [AdminWebhook] Fired for card X (label) ‚Äî HTTP 200
        const m = l.msg.match(/Fired for card \d+ \((.+?)\)/);
        whAddFire({
            label: m ? m[1] : 'Card',
            username: '‚Äî',
            card_type: '‚Äî',
            ts: l.ts,
        });
    });
    _lastWhLogSeen = _logLines.length;
}
async function saveQuietHours() {
    const btn = document.getElementById('quiet-save-btn');
    const orig = btn.textContent;
    btn.textContent = '‚ü≥ Saving...'; btn.disabled = true;
    try {
        const r = await fetch('/admin/quiet-hours', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                enabled: document.getElementById('quiet-enabled').checked,
                start: parseInt(document.getElementById('quiet-start').value),
                end: parseInt(document.getElementById('quiet-end').value)
            })
        });
        const d = await r.json();
        if (d.success) {
            btn.textContent = '‚úÖ Saved!';
            const badge = document.getElementById('quiet-status-badge');
            const enabled = document.getElementById('quiet-enabled').checked;
            const s = document.getElementById('quiet-start').value;
            const e = document.getElementById('quiet-end').value;
            if (enabled) {
                badge.className = 'text-xs px-2.5 py-1 rounded-full border bg-indigo-900/30 text-indigo-300 border-indigo-800';
                badge.textContent = `‚óè Active ‚Äî ${s}:00‚Äì${e}:00 UTC`;
            } else {
                badge.className = 'text-xs px-2.5 py-1 rounded-full border bg-slate-800 text-slate-500 border-slate-700';
                badge.textContent = '‚óã Off';
            }
        } else {
            btn.textContent = '‚ùå Error';
        }
        setTimeout(() => { btn.textContent = orig; btn.disabled = false; }, 2500);
    } catch(e) { btn.textContent = '‚ùå Error'; setTimeout(() => { btn.textContent = orig; btn.disabled = false; }, 2500); }
}

// Hook into the existing fetchLogs cycle
const _origFetchLogs = fetchLogs;
async function fetchLogs() {
    await _origFetchLogs();
    checkLogsForWebhookFires();
}

</script>
{% endblock %}
