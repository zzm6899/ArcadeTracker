{% extends "base.html" %}
{% block title %}Admin ‚Äì Balance Tracker{% endblock %}
{% block content %}

<div class="flex items-center justify-between mb-6 flex-wrap gap-3">
    <div>
        <h1 class="text-xl font-bold text-white">‚öôÔ∏è Admin</h1>
        <p class="text-slate-500 text-sm mt-0.5">{{ users|length }} users ¬∑ {{ cards|length }} active cards</p>
    </div>
    <a href="/dashboard" class="text-slate-500 hover:text-white text-sm transition">‚Üê Dashboard</a>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}{% for cat, msg in messages %}
<div class="mb-4 px-4 py-2.5 rounded-xl text-sm {% if cat == 'success' %}bg-green-900/30 border border-green-700 text-green-300{% else %}bg-red-900/30 border border-red-700 text-red-300{% endif %}">{{ msg }}</div>
{% endfor %}{% endif %}{% endwith %}

<!-- Users -->
<div class="card rounded-2xl p-5 mb-5">
    <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4">üë• Users</h2>
    <div class="space-y-3">
    {% for u in users %}
    {% set is_root = (u.id == 1) or (u.username == admin_username) %}
    {% set st = tz_statuses.get(u.id, 'disconnected') %}
    <div class="bg-slate-800/40 rounded-xl p-4 border border-slate-700/50">
        <div class="flex items-start justify-between gap-3 flex-wrap">
            <div class="flex items-center gap-3 flex-wrap">
                <div>
                    <div class="flex items-center gap-2 mb-0.5">
                        <span class="font-medium text-white">{{ u.username }}</span>
                        {% if is_root %}<span class="text-xs text-slate-600 border border-slate-700 px-1.5 py-0.5 rounded">root</span>{% endif %}
                        {% if u.is_admin %}<span class="text-xs bg-indigo-900/50 text-indigo-300 border border-indigo-800 px-2 py-0.5 rounded-full">Admin</span>{% endif %}
                    </div>
                    <div class="flex items-center gap-3 text-xs text-slate-500 flex-wrap">
                        <span class="{% if st == 'connected' %}text-green-400{% elif st in ['error','stale'] %}text-red-400{% endif %}">TZ: {{ st }}</span>
                        <span>Discord: {{ '‚úì linked' if u.discord_id else '‚Äî none' }}</span>
                        <span>Joined: {{ u.created_at[:10] }}</span>
                    </div>
                </div>

                <!-- Leaderboard opt-in toggle -->
                <form method="POST" action="/admin/users/{{ u.id }}/leaderboard" class="flex items-center gap-2">
                    <input type="hidden" name="leaderboard_opt_in" value="{{ '0' if u.leaderboard_opt_in else '1' }}">
                    <button class="text-xs px-2.5 py-1 rounded-lg border transition
                        {% if u.leaderboard_opt_in %}bg-green-900/30 text-green-400 border-green-900 hover:bg-slate-800{% else %}border-slate-700 text-slate-500 hover:border-green-900 hover:text-green-400{% endif %}">
                        üèÜ {{ 'LB: On' if u.leaderboard_opt_in else 'LB: Off' }}
                    </button>
                </form>
            </div>

            <!-- Actions -->
            <div class="flex items-center gap-2 flex-wrap">
                <!-- Rename -->
                <button onclick="toggleRename({{ u.id }})" class="text-xs text-slate-400 hover:text-white px-2 py-1 border border-slate-700 rounded-lg transition">‚úèÔ∏è Rename</button>

                <!-- Admin toggle -->
                {% if not u.is_admin %}
                <form method="POST" action="/admin/make-admin/{{ u.id }}">
                    <button class="text-xs text-indigo-400 px-2 py-1 border border-indigo-900 rounded-lg hover:bg-indigo-900/30 transition">+ Admin</button>
                </form>
                {% elif not is_root %}
                <form method="POST" action="/admin/remove-admin/{{ u.id }}" onsubmit="return confirm('Remove admin from {{ u.username }}?')">
                    <button class="text-xs text-orange-400 px-2 py-1 border border-orange-900 rounded-lg hover:bg-orange-900/20 transition">‚àí Admin</button>
                </form>
                {% endif %}

                <!-- Delete user -->
                {% if not is_root and u.id != current_user.id %}
                <form method="POST" action="/admin/users/{{ u.id }}/delete" onsubmit="return confirm('Delete {{ u.username }}? This cannot be undone.')">
                    <button class="text-xs text-red-400 px-2 py-1 border border-red-900 rounded-lg hover:bg-red-900/20 transition">üóë Delete</button>
                </form>
                {% endif %}
            </div>
        </div>

        <!-- Rename form (hidden) -->
        <form method="POST" action="/admin/users/{{ u.id }}/rename" id="rename-form-{{ u.id }}" class="hidden mt-3 flex items-center gap-2">
            <input name="new_username" type="text" value="{{ u.username }}"
                class="input-field flex-1 px-3 py-1.5 rounded-lg text-sm" placeholder="New username">
            <button type="submit" class="text-xs text-white btn-primary px-3 py-1.5 rounded-lg">Save</button>
            <button type="button" onclick="toggleRename({{ u.id }})" class="text-xs text-slate-500 px-2 py-1.5">Cancel</button>
        </form>
    </div>
    {% endfor %}
    </div>
</div>

<!-- All Cards -->
<div class="card rounded-2xl p-5 mb-5">
    <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4">üÉè All Cards</h2>
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead>
                <tr class="text-xs text-slate-500 uppercase tracking-wider border-b border-slate-800">
                    <th class="text-left pb-2 pr-3">User</th>
                    <th class="text-left pb-2 pr-3">Type</th>
                    <th class="text-left pb-2 pr-3">Label</th>
                    <th class="text-left pb-2 pr-3">Balance</th>
                    <th class="text-left pb-2 pr-3">Bonus</th>
                    <th class="text-left pb-2 pr-3">Points</th>
                    <th class="text-left pb-2 pr-3">Poll</th>
                    <th class="text-left pb-2 pr-3">Updated</th>
                    <th class="text-left pb-2">Leaderboard</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-800/50">
            {% for card in cards %}
            <tr class="text-slate-300 hover:bg-slate-800/20">
                <td class="py-2 pr-3 text-xs font-medium text-white">{{ card.username }}</td>
                <td class="py-2 pr-3">
                    <span class="text-xs px-1.5 py-0.5 rounded {% if card.card_type == 'timezone' %}bg-yellow-900/40 text-yellow-400{% else %}bg-purple-900/40 text-purple-400{% endif %}">
                        {{ card.card_type }}
                    </span>
                    {% if card.tier %}<span class="text-xs text-slate-500 ml-1">{{ card.tier }}</span>{% endif %}
                </td>
                <td class="py-2 pr-3 text-sm text-slate-300">{{ card.card_label or card.card_number }}</td>
                <td class="py-2 pr-3 text-green-400 text-xs font-medium">${{ "%.2f"|format(card.cash_balance or 0) }}</td>
                <td class="py-2 pr-3 text-yellow-400 text-xs">${{ "%.2f"|format(card.cash_bonus or 0) }}</td>
                <td class="py-2 pr-3 text-orange-400 text-xs">{{ card.points or 0 }}</td>
                <td class="py-2 pr-3 text-slate-500 text-xs">{{ card.poll_interval or 60 }}s</td>
                <td class="py-2 pr-3 text-slate-500 text-xs">{{ card.last_updated[:16] if card.last_updated else 'Never' }}</td>
                <td class="py-2">
                    <form method="POST" action="/admin/cards/{{ card.id }}/leaderboard">
                        <input type="hidden" name="leaderboard_public" value="{{ '0' if card.leaderboard_public else '1' }}">
                        <button class="text-xs px-2 py-1 rounded-lg border transition
                            {% if card.leaderboard_public %}bg-green-900/30 text-green-400 border-green-900{% else %}border-slate-700 text-slate-600 hover:text-green-400 hover:border-green-900{% endif %}">
                            {{ '‚úì Public' if card.leaderboard_public else '‚Äî Private' }}
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Timezone Sessions -->
{% if tz_sessions %}
<div class="card rounded-2xl p-5">
    <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4">üïπÔ∏è Timezone Sessions</h2>
    <div class="space-y-2">
    {% for ts in tz_sessions %}
    {% set st = tz_statuses.get(ts.user_id, 'disconnected') %}
    <div class="bg-slate-800/40 rounded-xl p-3.5 flex items-start justify-between gap-4 flex-wrap">
        <div>
            <div class="flex items-center gap-2 mb-1">
                <span class="font-medium text-white text-sm">{{ ts.username }}</span>
                <span class="text-xs px-2 py-0.5 rounded-full
                    {% if st == 'connected' %}bg-green-900/40 text-green-400
                    {% elif st in ['stale','error'] %}bg-red-900/40 text-red-400
                    {% else %}bg-slate-700 text-slate-400{% endif %}">{{ st }}</span>
            </div>
            <div class="text-xs text-slate-500">
                Token: <span class="text-slate-400">{{ ts.token_expires_at or '?' }}</span> ¬∑
                Last poll: <span class="{% if ts.last_poll_status == 'ok' %}text-green-400{% elif ts.last_poll_status %}text-red-400{% else %}text-slate-400{% endif %}">
                    {{ ts.last_poll_at or 'Never' }}{% if ts.last_poll_status %} ({{ ts.last_poll_status }}){% endif %}
                </span>
            </div>
        </div>
        <div class="flex flex-col gap-1 items-end shrink-0">
        {% if st in ['stale','error'] %}
        <button onclick="tzReauth({{ ts.user_id }}, this)"
            class="text-xs text-red-300 bg-red-900/20 border border-red-900 hover:bg-red-900/40 rounded-lg px-2 py-1 transition">
            ‚ö†Ô∏è {{ 'Error' if st == 'error' else 'Stale' }} ‚Äî üîÑ Refresh Token
        </button>
        {% else %}
        <button onclick="tzReauth({{ ts.user_id }}, this)"
            class="text-xs text-slate-600 hover:text-slate-400 border border-slate-700 hover:border-slate-600 rounded-lg px-2 py-1 transition">
            üîÑ Refresh Token
        </button>
        {% endif %}
        </div>
    </div>
    {% endfor %}
    </div>
</div>
{% endif %}


<!-- Console Log -->
<div class="card rounded-2xl p-5 mt-6">
    <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">üñ•Ô∏è Console Log</h2>
        <div class="flex items-center gap-2">
            <input id="log-filter" type="text" placeholder="Filter logs..."
                class="input-field text-xs px-3 py-1.5 rounded-lg w-40"
                oninput="filterLogs()">
            <label class="flex items-center gap-1.5 text-xs text-slate-500 cursor-pointer">
                <input type="checkbox" id="log-autoscroll" checked class="rounded"> Auto-scroll
            </label>
            <label class="flex items-center gap-1.5 text-xs text-slate-500 cursor-pointer">
                <input type="checkbox" id="log-autorefresh" checked class="rounded"> Live
            </label>
            <button onclick="clearLogDisplay()" class="text-xs text-slate-600 hover:text-slate-400 px-2 py-1 border border-slate-700 rounded-lg">Clear</button>
        </div>
    </div>
    <div id="log-console"
        class="bg-slate-950 rounded-xl p-3 font-mono text-xs overflow-y-auto space-y-0.5"
        style="height: 340px;">
        <div class="text-slate-600">Loading logs...</div>
    </div>
</div>

<script>
let _logLines = [];
let _logRefreshInterval = null;
let _logSeen = 0;

const LEVEL_STYLES = {
    'ERROR':   'text-red-400',
    'WARNING': 'text-yellow-400',
    'INFO':    'text-slate-300',
    'DEBUG':   'text-slate-500',
};

function renderLogs() {
    const filter = (document.getElementById('log-filter').value || '').toLowerCase();
    const console_ = document.getElementById('log-console');
    const autoscroll = document.getElementById('log-autoscroll').checked;

    const filtered = filter
        ? _logLines.filter(l => l.msg.toLowerCase().includes(filter) || l.level.toLowerCase().includes(filter))
        : _logLines;

    console_.innerHTML = filtered.length === 0
        ? '<div class="text-slate-600">No logs yet.</div>'
        : filtered.map(l => {
            const cls = LEVEL_STYLES[l.level] || 'text-slate-400';
            const lvl = l.level === 'ERROR' ? `<span class="text-red-500 font-bold">[ERR]</span>` :
                        l.level === 'WARNING' ? `<span class="text-yellow-500">[WRN]</span>` : '';
            // Colour-code known prefixes
            const msg = l.msg
                .replace(/\[Poller\]/g, '<span class="text-blue-400">[Poller]</span>')
                .replace(/\[Timezone\]/g, '<span class="text-purple-400">[Timezone]</span>')
                .replace(/\[Startup\]/g, '<span class="text-cyan-400">[Startup]</span>')
                .replace(/\[Reauth\]/g, '<span class="text-yellow-400">[Reauth]</span>')
                .replace(/\[Token watcher\]/g, '<span class="text-yellow-400">[Token watcher]</span>')
                .replace(/\[Bot\]/g, '<span class="text-indigo-400">[Bot]</span>')
                .replace(/\[Discord\]/g, '<span class="text-indigo-400">[Discord]</span>')
                .replace(/\[Mail\]/g, '<span class="text-pink-400">[Mail]</span>')
                .replace(/HTTP 200/g, '<span class="text-green-500">HTTP 200</span>')
                .replace(/HTTP [45]\d\d/g, m => `<span class="text-red-400">${m}</span>`)
                .replace(/SUCCESS/g, '<span class="text-green-400 font-bold">SUCCESS</span>');
            return `<div class="flex gap-2 leading-5 hover:bg-slate-900/50 px-1 rounded">
                <span class="text-slate-600 shrink-0 w-36">${l.ts}</span>
                ${lvl}
                <span class="${cls} break-all">${msg}</span>
            </div>`;
        }).join('');

    if (autoscroll) console_.scrollTop = console_.scrollHeight;
}

function filterLogs() { renderLogs(); }

function clearLogDisplay() {
    _logLines = [];
    _logSeen = 0;
    document.getElementById('log-console').innerHTML = '<div class="text-slate-600">Cleared.</div>';
}

async function fetchLogs() {
    try {
        const r = await fetch('/admin/logs');
        const d = await r.json();
        if (d.lines && d.lines.length !== _logSeen) {
            _logLines = d.lines;
            _logSeen = d.lines.length;
            renderLogs();
        }
    } catch(e) {
        document.getElementById('log-console').innerHTML = '<div class="text-red-400">Failed to fetch logs.</div>';
    }
}

// Auto-refresh toggle
document.getElementById('log-autorefresh').addEventListener('change', function() {
    if (this.checked) {
        _logRefreshInterval = setInterval(fetchLogs, 2000);
    } else {
        clearInterval(_logRefreshInterval);
    }
});

// Initial load + start live refresh
fetchLogs();
_logRefreshInterval = setInterval(fetchLogs, 2000);
</script>

<script>
async function tzReauth(userId, btn) {
    const orig = btn.textContent;
    btn.textContent = '‚ü≥ Refreshing...'; btn.disabled = true;
    try {
        const r = await fetch('/api/timezone/reauth', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({user_id: userId})
        });
        const d = await r.json();
        if (d.success) {
            btn.textContent = '‚úÖ Refreshed!';
            btn.className = btn.className.replace(/text-red-\w+/g, 'text-green-400').replace(/border-red-\w+/g, 'border-green-700').replace(/bg-red-\w+\/\w+/g, '');
            setTimeout(() => location.reload(), 1500);
        } else {
            btn.textContent = '‚ùå ' + (d.error || 'Failed');
            setTimeout(() => { btn.textContent = orig; btn.disabled = false; }, 3000);
        }
    } catch(e) { btn.textContent = orig; btn.disabled = false; }
}

function toggleRename(uid) {
    const f = document.getElementById('rename-form-' + uid);
    f.classList.toggle('hidden');
    if (!f.classList.contains('hidden')) f.querySelector('input').focus();
}
</script>
{% endblock %}
