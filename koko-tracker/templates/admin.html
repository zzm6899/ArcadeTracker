{% extends "base.html" %}
{% block title %}Admin ‚Äì Balance Tracker{% endblock %}
{% block content %}

<div class="flex items-center justify-between mb-6 flex-wrap gap-3">
    <div>
        <h1 class="text-xl font-bold text-white">‚öôÔ∏è Admin</h1>
        <p class="text-slate-500 text-sm mt-0.5">{{ users|length }} users ¬∑ {{ cards|length }} active cards</p>
    </div>
    <a href="/dashboard" class="text-slate-500 hover:text-white text-sm transition">‚Üê Dashboard</a>
</div>

<!-- Users -->
<div class="card rounded-2xl p-5 mb-5">
    <h2 class="text-sm font-semibold text-slate-300 uppercase tracking-wider mb-4">üë• Users</h2>
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead>
                <tr class="text-xs text-slate-500 uppercase tracking-wider border-b border-slate-700/50">
                    <th class="text-left pb-2 pr-4">Username</th>
                    <th class="text-left pb-2 pr-4">Role</th>
                    <th class="text-left pb-2 pr-4">TZ Session</th>
                    <th class="text-left pb-2 pr-4">Timezone</th>
                    <th class="text-left pb-2 pr-4">Joined</th>
                    <th class="text-left pb-2">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-800">
            {% for u in users %}
            <tr class="text-slate-300">
                <td class="py-2.5 pr-4 font-medium text-white">{{ u.username }}</td>
                <td class="py-2.5 pr-4">
                    {% if u.is_admin %}<span class="text-xs bg-indigo-900/50 text-indigo-300 border border-indigo-800 px-2 py-0.5 rounded-full">Admin</span>
                    {% else %}<span class="text-xs text-slate-600">User</span>{% endif %}
                </td>
                <td class="py-2.5 pr-4">
                    {% set st = tz_statuses.get(u.id, 'disconnected') %}
                    <span class="text-xs px-2 py-0.5 rounded-full
                        {% if st == 'connected' %}bg-green-900/40 text-green-400 border border-green-800
                        {% elif st == 'stale' %}bg-yellow-900/40 text-yellow-400 border border-yellow-800
                        {% elif st == 'error' %}bg-red-900/40 text-red-400 border border-red-800
                        {% else %}bg-slate-800 text-slate-500{% endif %}">{{ st }}</span>
                </td>
                <td class="py-2.5 pr-4 text-xs text-slate-500">{{ u.timezone_name or 'Sydney' }}</td>
                <td class="py-2.5 pr-4 text-xs text-slate-600">{{ u.created_at[:10] }}</td>
                <td class="py-2.5">
                    {% if not u.is_admin %}
                    <form method="POST" action="/admin/make-admin/{{ u.id }}" class="inline">
                        <button class="text-xs text-indigo-400 hover:text-indigo-300 transition">Make Admin</button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- All Cards -->
<div class="card rounded-2xl p-5 mb-5">
    <h2 class="text-sm font-semibold text-slate-300 uppercase tracking-wider mb-4">üÉè All Cards</h2>
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead>
                <tr class="text-xs text-slate-500 uppercase tracking-wider border-b border-slate-700/50">
                    <th class="text-left pb-2 pr-3">User</th>
                    <th class="text-left pb-2 pr-3">Type</th>
                    <th class="text-left pb-2 pr-3">Label</th>
                    <th class="text-left pb-2 pr-3">Balance</th>
                    <th class="text-left pb-2 pr-3">Bonus</th>
                    <th class="text-left pb-2 pr-3">Points</th>
                    <th class="text-left pb-2 pr-3">Poll</th>
                    <th class="text-left pb-2">Last Updated</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-800">
            {% for card in cards %}
            <tr class="text-slate-300 hover:bg-slate-800/30">
                <td class="py-2.5 pr-3 text-xs font-medium text-white">{{ card.username }}</td>
                <td class="py-2.5 pr-3">
                    <span class="text-xs px-1.5 py-0.5 rounded font-medium {% if card.card_type == 'timezone' %}bg-yellow-900/40 text-yellow-400{% else %}bg-purple-900/40 text-purple-400{% endif %}">
                        {{ card.card_type }}
                    </span>
                </td>
                <td class="py-2.5 pr-3 text-sm">{{ card.card_label or card.card_number }}</td>
                <td class="py-2.5 pr-3 text-green-400 font-medium">${{ "%.2f"|format(card.cash_balance or 0) }}</td>
                <td class="py-2.5 pr-3 text-yellow-400">${{ "%.2f"|format(card.cash_bonus or 0) }}</td>
                <td class="py-2.5 pr-3 text-orange-400">{{ card.points or 0 }}</td>
                <td class="py-2.5 pr-3 text-xs text-slate-500">{{ card.poll_interval or 60 }}s</td>
                <td class="py-2.5 text-xs {% if not card.last_updated %}text-slate-600{% else %}text-slate-400{% endif %}">
                    {{ card.last_updated[:16] if card.last_updated else 'Never' }}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Timezone Sessions -->
{% if tz_sessions %}
<div class="card rounded-2xl p-5">
    <h2 class="text-sm font-semibold text-slate-300 uppercase tracking-wider mb-4">üïπÔ∏è Timezone Sessions</h2>
    <div class="space-y-2">
    {% for ts in tz_sessions %}
    {% set st = tz_statuses.get(ts.user_id, 'disconnected') %}
    <div class="bg-slate-800/50 rounded-xl p-4 flex items-start justify-between gap-4 flex-wrap">
        <div>
            <div class="flex items-center gap-2 mb-1">
                <span class="font-medium text-white text-sm">{{ ts.username }}</span>
                <span class="text-xs px-2 py-0.5 rounded-full
                    {% if st == 'connected' %}bg-green-900/40 text-green-400 border border-green-800
                    {% elif st == 'stale' %}bg-yellow-900/40 text-yellow-400 border border-yellow-800
                    {% elif st == 'error' %}bg-red-900/40 text-red-400 border border-red-800
                    {% else %}bg-slate-700 text-slate-400{% endif %}">{{ st }}</span>
            </div>
            <div class="text-xs text-slate-500 space-y-0.5">
                <div>Token expires: <span class="text-slate-400">{{ ts.token_expires_at or 'Unknown' }}</span></div>
                <div>Last poll: <span class="{% if ts.last_poll_status == 'ok' %}text-green-400{% elif ts.last_poll_status %}text-red-400{% else %}text-slate-400{% endif %}">
                    {{ ts.last_poll_at or 'Never' }}{% if ts.last_poll_status %} ({{ ts.last_poll_status }}){% endif %}
                </span></div>
            </div>
        </div>
        {% if st in ['stale', 'error'] %}
        <div class="text-xs text-red-300 bg-red-900/20 border border-red-900 rounded-lg px-3 py-2">
            ‚ö†Ô∏è {{ 'API error ‚Äî token likely expired' if st == 'error' else 'No recent polls' }}
        </div>
        {% endif %}
    </div>
    {% endfor %}
    </div>
</div>
{% endif %}

{% endblock %}
