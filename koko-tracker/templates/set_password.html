{% extends "base.html" %}
{% block title %}Set Password ‚Äì Balance Tracker{% endblock %}
{% block content %}
<div class="max-w-sm mx-auto">
  <div class="card rounded-2xl p-7">
    <div class="text-center mb-6">
      <div class="text-4xl mb-3">üîê</div>
      <h1 class="font-display font-bold text-xl gradient-text">Set a Password</h1>
      <p class="text-sm mt-2 text-muted">
        Your account was created via Discord.<br>
        Set a password to also log in with your username.
      </p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}{% for cat, msg in messages %}
    <div class="flash-{{ cat }} rounded-xl px-4 py-3 text-sm mb-5">{{ msg }}</div>
    {% endfor %}{% endif %}{% endwith %}

    <form method="POST" class="space-y-4" onsubmit="return validateForm()">
      <div>
        <label class="block text-xs font-semibold uppercase tracking-wider mb-2 text-muted">New Password</label>
        <input name="password" id="password" type="password" required autofocus
          class="input-field w-full px-4 py-3 rounded-xl text-sm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          oninput="checkPassword(this.value)">
        <div class="mt-3 space-y-1.5">
          {% for id, label in [('len','At least 8 characters'),('upper','One uppercase letter'),('num','One number')] %}
          <div class="flex items-center gap-2 text-xs">
            <span id="icon-{{ id }}" class="w-4 h-4 rounded-full flex items-center justify-center text-[9px] flex-shrink-0 transition-all"
              style="border:1px solid var(--border);color:var(--text-muted)">‚úó</span>
            <span id="label-{{ id }}" class="text-muted">{{ label }}</span>
          </div>
          {% endfor %}
        </div>
      </div>
      <div>
        <label class="block text-xs font-semibold uppercase tracking-wider mb-2 text-muted">Confirm Password</label>
        <input name="confirm_password" id="confirm" type="password" required
          class="input-field w-full px-4 py-3 rounded-xl text-sm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          oninput="checkMatch()">
        <p class="text-xs mt-1.5 hidden" id="match-err" style="color:var(--danger)">Passwords don't match</p>
      </div>
      <button type="submit" id="submit-btn"
        class="btn-primary w-full py-3 rounded-xl text-sm" disabled style="opacity:0.38;cursor:not-allowed">
        Set Password
      </button>
    </form>
    <p class="text-center mt-4">
      <a href="/dashboard" class="text-xs text-faint hover:text-muted transition">Skip for now</a>
    </p>
  </div>
</div>
<script>
function checkPassword(val) {
  const len = val.length >= 8, upper = /[A-Z]/.test(val), num = /[0-9]/.test(val);
  setCheck('len',len); setCheck('upper',upper); setCheck('num',num);
  const ok = len && upper && num;
  const btn = document.getElementById('submit-btn');
  btn.disabled = !ok; btn.style.opacity = ok ? '' : '0.38'; btn.style.cursor = ok ? '' : 'not-allowed';
}
function setCheck(id, ok) {
  const icon = document.getElementById('icon-' + id), lbl = document.getElementById('label-' + id);
  icon.textContent = ok ? '‚úì' : '‚úó';
  icon.style.background  = ok ? 'rgba(34,197,94,0.15)' : '';
  icon.style.borderColor = ok ? 'rgba(34,197,94,0.4)' : '';
  icon.style.color       = ok ? '#4ade80' : '';
  lbl.style.color        = ok ? '#86efac' : '';
}
function checkMatch() {
  const match = document.getElementById('password').value === document.getElementById('confirm').value;
  document.getElementById('match-err').classList.toggle('hidden', match || !document.getElementById('confirm').value);
}
function validateForm() {
  const pw = document.getElementById('password').value, cm = document.getElementById('confirm').value;
  return pw === cm && pw.length >= 8 && /[A-Z]/.test(pw) && /[0-9]/.test(pw);
}
</script>
{% endblock %}
