{% extends "base.html" %}
{% block title %}Connect Timezone ‚Äì Koko Tracker{% endblock %}
{% block content %}

<div class="flex items-center gap-4 mb-6">
    <a href="/dashboard" class="text-slate-400 hover:text-white transition">‚Üê Dashboard</a>
</div>

<div class="max-w-md mx-auto">
    <div class="card rounded-2xl p-8">
        <div class="text-center mb-6">
            <div class="text-5xl mb-3">üïπÔ∏è</div>
            <h1 class="text-2xl font-bold text-white mb-1">Connect Timezone</h1>
            <p class="text-slate-400 text-sm">Takes about 1 minute</p>
        </div>

        <!-- Steps -->
        <div class="space-y-5 mb-8">

            <!-- Step 1 -->
            <div class="flex gap-4 items-start">
                <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold text-sm flex-shrink-0">1</div>
                <div class="flex-1">
                    <div class="text-white font-medium mb-1">Open Timezone Portal & log in</div>
                    <a href="https://portal.timezonegames.com" target="_blank" rel="noopener"
                        class="inline-block btn-primary px-4 py-2 rounded-lg text-sm text-white font-medium">
                        Open Timezone Portal ‚Üí
                    </a>
                    <p class="text-slate-500 text-xs mt-1">Complete your phone/email OTP login</p>
                </div>
            </div>

            <!-- Step 2 -->
            <div class="flex gap-4 items-start">
                <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold text-sm flex-shrink-0">2</div>
                <div class="flex-1">
                    <div class="text-white font-medium mb-2">Once logged in, paste this into the address bar</div>
                    <div class="relative">
                        <div id="bookmarklet-display"
                            class="bg-slate-900 border border-slate-600 rounded-lg p-3 text-xs font-mono text-yellow-300 break-all cursor-pointer"
                            onclick="copyCode()">
                            <!-- Code rendered by JS to avoid HTML encoding issues -->
                        </div>
                        <button id="copy-btn" onclick="copyCode()"
                            class="absolute top-2 right-2 text-xs text-slate-400 hover:text-white bg-slate-700 px-2 py-1 rounded transition">
                            Copy
                        </button>
                    </div>
                    <p class="text-slate-500 text-xs mt-2">üëÜ Tap the code to copy it, then paste it into the Timezone portal's address bar and press Enter</p>
                </div>
            </div>

            <!-- Step 3 -->
            <div class="flex gap-4 items-start">
                <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-slate-400 font-bold text-sm flex-shrink-0">3</div>
                <div>
                    <div class="text-slate-400 font-medium">You'll be redirected back here automatically</div>
                    <p class="text-slate-500 text-xs mt-0.5">Your cards will appear ready to track</p>
                </div>
            </div>
        </div>

        <!-- Mobile tip -->
        <div class="bg-slate-800 rounded-xl p-4 text-xs text-slate-400">
            <strong class="text-slate-300">üì± On mobile?</strong> After copying the code, go to the Timezone portal tab, tap the address bar, <strong class="text-slate-300">clear it</strong>, paste the code, and tap Go.
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var appUrl = {{ app_url | tojson }};

    var bookmarklet = 'javascript:void(function(){' +
        'var t=null,at=null,rt=null,cid=null;' +
        'for(var i=0;i<localStorage.length;i++){' +
            'var k=localStorage.key(i);' +
            'var v=localStorage.getItem(k);' +
            'if(v){try{' +
                'var p=JSON.parse(v);' +
                'if(p.secret&&p.secret.startsWith(\'eyJ\')){' +
                    'if(k.indexOf(\'accesstoken\')>-1){at=p.secret;if(p.clientId)cid=p.clientId;}' +
                    'else if(k.indexOf(\'idtoken\')>-1&&!at){t=p.secret;}' +
                '}' +
                'if(p.credentialType===\'RefreshToken\'&&p.secret){rt=p.secret;if(p.clientId)cid=p.clientId;}' +
            '}catch(e){}}' +
        '}' +
        'var tok=at||t;' +
        'if(tok){' +
            'var u=\''+appUrl+'/timezone/landing?token=\'+encodeURIComponent(tok);' +
            'if(rt)u+=\'&refresh_token=\'+encodeURIComponent(rt);' +
            'if(cid)u+=\'&client_id=\'+encodeURIComponent(cid);' +
            'window.location=u;' +
        '}else{alert(\'Not logged in to Timezone yet!\');}' +
    '})();';

    var display = document.getElementById('bookmarklet-display');
    if (display) display.textContent = bookmarklet;
    window._bookmarklet = bookmarklet;
});

function showToast(msg, success) {
    var toast = document.createElement('div');
    toast.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg text-sm z-50 ' + (success ? 'bg-green-800 text-green-200' : 'bg-slate-700 text-slate-200');
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(function() { toast.remove(); }, 2500);
}

function copyCode() {
    var el = document.getElementById('bookmarklet-display');
    var btn = document.getElementById('copy-btn');
    var text = window._bookmarklet;
    if (!text) { showToast('Code not ready yet', false); return; }

    // Modern clipboard API
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function() {
            btn.textContent = '‚úÖ Copied!';
            btn.style.background = '#16a34a';
            setTimeout(function() { btn.textContent = 'Copy'; btn.style.background = ''; }, 2000);
        }).catch(fallbackCopy);
    } else {
        fallbackCopy();
    }
}

function fallbackCopy() {
    var text = window._bookmarklet;
    var ta = document.createElement('textarea');
    ta.value = text;
    ta.style.cssText = 'position:fixed;top:0;left:0;opacity:0;';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try {
        document.execCommand('copy');
        showToast('‚úÖ Copied!', true);
        var btn = document.getElementById('copy-btn');
        if (btn) { btn.textContent = '‚úÖ Copied!'; setTimeout(function(){ btn.textContent = 'Copy'; }, 2000); }
    } catch(e) {
        showToast('Long-press the code to select & copy', false);
    }
    document.body.removeChild(ta);
}
</script>

{% endblock %}
