{% extends "base.html" %}
{% block title %}Sign in to Timezone ‚Äì Balance Tracker{% endblock %}
{% block content %}

<div class="flex items-center gap-4 mb-6">
    <a href="/timezone/start" class="text-slate-400 hover:text-white transition">‚Üê Back</a>
</div>

<div class="max-w-md mx-auto">
    <div class="card rounded-2xl p-8 text-center">

        <div id="state-init">
            <div class="text-5xl mb-4">üîê</div>
            <h2 class="text-xl font-bold text-white mb-2">Sign in to Timezone</h2>
            <p class="text-slate-400 text-sm mb-6">A login window will open. Sign in with your phone number or email ‚Äî same as the Timezone app.</p>
            <button id="login-btn" onclick="doLogin()" disabled
                class="w-full btn-primary py-4 rounded-xl text-white font-semibold text-lg transition hover:brightness-110 disabled:opacity-50">
                Preparing...
            </button>
            <p class="text-slate-500 text-xs mt-3">Long-lived session ‚Äî no 24h expiry</p>
        </div>

        <div id="state-waiting" class="hidden">
            <div class="text-5xl mb-4">‚è≥</div>
            <h2 class="text-xl font-bold text-white mb-2">Waiting for login...</h2>
            <p class="text-slate-400 text-sm mb-6">Complete the sign-in in the popup window. This page will update automatically.</p>
            <div class="flex justify-center mb-4">
                <div class="w-8 h-8 border-2 border-indigo-400 border-t-transparent rounded-full animate-spin"></div>
            </div>
            <button onclick="doLogin()" class="text-sm text-slate-500 hover:text-white transition">Window didn't open? Click to retry</button>
        </div>

        <div id="state-exchanging" class="hidden">
            <div class="text-5xl mb-4">üîÑ</div>
            <h2 class="text-xl font-bold text-white mb-2">Connecting...</h2>
            <p class="text-slate-400 text-sm mb-4">Exchanging tokens</p>
            <div class="flex justify-center">
                <div class="w-8 h-8 border-2 border-green-400 border-t-transparent rounded-full animate-spin"></div>
            </div>
        </div>

        <div id="state-success" class="hidden">
            <div class="text-5xl mb-4">‚úÖ</div>
            <h2 class="text-xl font-bold text-white mb-2">Connected!</h2>
            <p class="text-slate-400 text-sm mb-2" id="success-msg"></p>
            <p class="text-green-400 text-xs mb-4">üîã Long-lived session ‚Äî no 24h expiry</p>
            <div id="card-list" class="space-y-3 text-left mb-6"></div>
            <a href="/dashboard" class="block w-full btn-primary py-3 rounded-xl text-white font-medium">
                Go to Dashboard ‚Üí
            </a>
        </div>

        <div id="state-error" class="hidden">
            <div class="text-5xl mb-4">‚ùå</div>
            <h2 class="text-xl font-bold text-white mb-2">Something went wrong</h2>
            <p id="error-msg" class="text-red-400 text-sm mb-4"></p>
            <p id="error-detail" class="text-slate-500 text-xs mb-6 break-all"></p>
            <button onclick="doLogin()" class="block w-full btn-primary py-3 rounded-xl text-white font-medium mb-3">Try again</button>
            <a href="/timezone/start" class="text-sm text-slate-500 hover:text-slate-300">Use bookmarklet method instead</a>
        </div>

    </div>
</div>

<script>
const CLIENT_ID     = {{ client_id | tojson }};
const SCOPE         = {{ scope | tojson }};
const AUTHORIZE_URL = {{ authorize_url | tojson }};
const REDIRECT_URI  = 'https://portal.timezonegames.com/authentication/login-callback';

// Pre-computed auth URL (ready before user clicks ‚Äî avoids async popup blocking)
let readyUrl = null;
let readyVerifier = null;
let pollTimer = null;

function setState(name, msg, detail) {
    ['init','waiting','exchanging','success','error'].forEach(s =>
        document.getElementById('state-' + s).classList.add('hidden'));
    document.getElementById('state-' + name).classList.remove('hidden');
    if (msg) {
        const el = document.getElementById(name === 'error' ? 'error-msg' : 'success-msg');
        if (el) el.textContent = msg;
    }
    if (detail) {
        const el = document.getElementById('error-detail');
        if (el) el.textContent = detail;
    }
}

// ‚îÄ‚îÄ PKCE ‚îÄ‚îÄ
function makeVerifier() {
    const a = new Uint8Array(64);
    crypto.getRandomValues(a);
    return btoa(String.fromCharCode(...a)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'').slice(0,128);
}

async function makeChallenge(v) {
    const h = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(v));
    return btoa(String.fromCharCode(...new Uint8Array(h))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}

function makeState() {
    const a = new Uint8Array(32);
    crypto.getRandomValues(a);
    return btoa(String.fromCharCode(...a)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}

// ‚îÄ‚îÄ Pre-compute auth URL on page load (before any click) ‚îÄ‚îÄ
async function prepare() {
    readyVerifier = makeVerifier();
    const ch = await makeChallenge(readyVerifier);
    const st = makeState();
    readyUrl = AUTHORIZE_URL + '?' + new URLSearchParams({
        client_id: CLIENT_ID,
        response_type: 'code',
        redirect_uri: REDIRECT_URI,
        scope: SCOPE,
        state: st,
        code_challenge: ch,
        code_challenge_method: 'S256',
        response_mode: 'query',
    }).toString();
    const btn = document.getElementById('login-btn');
    if (btn) { btn.disabled = false; btn.textContent = 'Open Timezone Login ‚Üí'; }
}

// ‚îÄ‚îÄ Click handler: opens popup SYNCHRONOUSLY (no async = no blocker) ‚îÄ‚îÄ
function doLogin() {
    if (!readyUrl) return;

    // Capture current values before regenerating
    const url = readyUrl;
    const verifier = readyVerifier;

    // Open popup immediately in the click handler (synchronous!)
    const w = 500, h = 700;
    const left = (screen.width - w) / 2;
    const top = (screen.height - h) / 2;
    const popup = window.open(url, 'tz_login',
        `width=${w},height=${h},left=${left},top=${top},toolbar=no,menubar=no,scrollbars=yes`);

    // Regenerate for next attempt
    prepare();

    if (!popup) {
        setState('error', 'Popup was blocked. Please allow popups for this site, then try again.');
        return;
    }

    setState('waiting');

    // Poll popup URL to detect redirect back from B2C
    // Response comes back as fragment (#code=...) to portal.timezonegames.com/authentication/login-callback
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(function() {
        try {
            if (!popup || popup.closed) {
                clearInterval(pollTimer);
                setState('init');
                return;
            }
            var href = popup.location.href;
            if (href && href.indexOf('portal.timezonegames.com/authentication/login-callback') !== -1) {
                clearInterval(pollTimer);
                popup.close();

                // Try query params first (?code=), fall back to hash fragment (#code=)
                var u = new URL(href);
                var params = u.searchParams.get('code')
                    ? u.searchParams
                    : new URLSearchParams(u.hash.slice(1));

                var err = params.get('error');
                if (err) {
                    setState('error',
                        decodeURIComponent(params.get('error_description') || err),
                        'Error: ' + err);
                    return;
                }
                var code = params.get('code');
                if (code) {
                    exchangeCode(code, verifier);
                } else {
                    setState('error', 'No authorization code received. URL: ' + href.slice(0,120));
                }
            }
        } catch(e) {
            // Cross-origin ‚Äî popup still on B2C/identity domain, keep waiting
        }
    }, 300);
}

async function exchangeCode(code, verifier) {
    setState('exchanging');
    try {
        var resp = await fetch('/timezone/oauth-exchange', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                code: code,
                code_verifier: verifier,
                redirect_uri: REDIRECT_URI,
            })
        });
        var result = await resp.json();
        if (result.success) {
            renderCards(result.cards, result.name);
        } else {
            setState('error', result.error || 'Token exchange failed', result.detail || '');
        }
    } catch(e) {
        setState('error', 'Network error: ' + e.message);
    }
}

function renderCards(cards, name) {
    setState('success', 'Connected as ' + name + '! Found ' + cards.length + ' card(s).');
    var list = document.getElementById('card-list');
    if (!cards.length) {
        setState('success', 'Connected as ' + name + '! No cards found yet ‚Äî they will appear after the first poll.');
        return;
    }
    list.innerHTML = cards.map(function(card) { return ''
        + '<div class="bg-slate-800 rounded-xl p-4">'
        + '  <div class="flex items-center justify-between mb-2">'
        + '    <div class="font-mono font-bold text-white">' + card.number + '</div>'
        + (card.tier ? '<span class="text-xs px-2 py-0.5 rounded-full font-medium '
            + (card.tier==='Platinum'?'bg-purple-900/60 text-purple-300':card.tier==='Gold'?'bg-yellow-900/60 text-yellow-300':'bg-slate-600 text-slate-300')
            + '">' + card.tier + '</span>' : '')
        + '  </div>'
        + '  <div class="grid grid-cols-3 gap-2 mb-3">'
        + '    <div class="bg-slate-900 rounded-lg p-2 text-center"><div class="text-xs text-slate-500">Credits</div><div class="font-bold text-green-400 text-sm">$' + card.cashBalance.toFixed(2) + '</div></div>'
        + '    <div class="bg-slate-900 rounded-lg p-2 text-center"><div class="text-xs text-slate-500">Bonus</div><div class="font-bold text-yellow-400 text-sm">$' + card.bonusBalance.toFixed(2) + '</div></div>'
        + '    <div class="bg-slate-900 rounded-lg p-2 text-center"><div class="text-xs text-slate-500">e-Tickets</div><div class="font-bold text-orange-400 text-sm">' + card.tickets + '</div></div>'
        + '  </div>'
        + '  <form method="POST" action="/timezone/add-card">'
        + '    <input type="hidden" name="card_number" value="' + card.number + '">'
        + '    <input type="hidden" name="cash_balance" value="' + card.cashBalance + '">'
        + '    <input type="hidden" name="bonus_balance" value="' + card.bonusBalance + '">'
        + '    <input type="hidden" name="tickets" value="' + card.tickets + '">'
        + '    <input type="hidden" name="tier" value="' + (card.tier||'') + '">'
        + '    <input type="hidden" name="card_label" value="Timezone ' + card.number + '">'
        + '    <button type="submit" class="w-full btn-primary py-2.5 rounded-lg text-sm font-medium text-white">+ Track this card</button>'
        + '  </form>'
        + '</div>';
    }).join('');
}

// Prepare auth URL immediately
prepare();
</script>

{% endblock %}
