{% extends "base.html" %}
{% block title %}{{ card.card_label or card.card_number or 'Card' }} ‚Äì Balance Tracker{% endblock %}
{% block content %}

<div class="flex items-center gap-3 mb-5">
    <a href="/dashboard" class="text-slate-500 hover:text-white transition text-sm">‚Üê Dashboard</a>
    <span class="text-slate-700">/</span>
    <span class="text-slate-400 text-sm" id="breadcrumb-label">{{ card.card_label or card.card_number }}</span>
</div>

<!-- Card Header -->
<div class="card rounded-2xl p-5 mb-4">
    <div class="flex items-start justify-between gap-3">
        <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-1 flex-wrap">
                {% if card.card_type == 'timezone' %}
                <span class="text-xs text-yellow-500 font-medium uppercase tracking-wider">üïπÔ∏è Timezone</span>
                {% else %}
                <span class="text-xs text-purple-400 font-medium uppercase tracking-wider">üéÆ Koko Card</span>
                {% endif %}
                {% if card.tier %}
                <span class="text-xs px-2 py-0.5 rounded-full font-medium
                    {% if card.tier == 'Platinum' %}bg-purple-900/60 text-purple-300 border border-purple-700
                    {% elif card.tier == 'Gold' %}bg-yellow-900/60 text-yellow-300 border border-yellow-700
                    {% elif card.tier == 'Silver' %}bg-slate-600/60 text-slate-300 border border-slate-500
                    {% else %}bg-orange-900/60 text-orange-300 border border-orange-700{% endif %}">
                    ‚òÖ {{ card.tier }}
                </span>
                {% endif %}
            </div>

            <!-- Editable card name -->
            <div class="flex items-center gap-2 group">
                <h1 class="text-xl font-bold text-white" id="card-title">{{ card.card_label or card.card_number or card.card_token }}</h1>
                <button onclick="startRename()" id="rename-btn"
                    class="opacity-0 group-hover:opacity-100 text-slate-600 hover:text-slate-300 transition text-sm px-1.5">‚úèÔ∏è</button>
            </div>
            <input id="rename-input" type="text" value="{{ card.card_label or card.card_number or '' }}"
                class="hidden input-field text-xl font-bold px-2 py-0.5 rounded-lg w-full max-w-xs mt-0.5"
                onkeydown="if(event.key==='Enter')saveRename(); if(event.key==='Escape')cancelRename()">
            <div id="rename-actions" class="hidden flex items-center gap-2 mt-1">
                <button onclick="saveRename()" class="text-xs text-green-400 hover:text-green-300 px-2 py-1 border border-green-900 rounded-lg transition">Save</button>
                <button onclick="cancelRename()" class="text-xs text-slate-500 hover:text-slate-300 px-2 py-1 border border-slate-700 rounded-lg transition">Cancel</button>
            </div>

            {% if card.card_number %}<p class="text-slate-600 text-xs font-mono mt-1">{{ card.card_number }}</p>{% endif %}
        </div>

        <div class="flex items-center gap-2 shrink-0">
            {% if card.card_type == 'timezone' %}
            <button onclick="importHistory()" id="import-btn"
                class="text-xs text-indigo-400 hover:text-white px-3 py-1.5 border border-indigo-900 rounded-lg transition">
                ‚¨á Import History
            </button>
            <button onclick="tzReauth(this)" id="reauth-btn"
                class="text-xs text-yellow-500 hover:text-yellow-300 px-3 py-1.5 border border-yellow-800/50 hover:border-yellow-600 rounded-lg transition">
                üîë Re-auth
            </button>
            {% endif %}
            <button onclick="forcePoll()" id="poll-btn"
                class="text-xs text-slate-500 hover:text-white px-3 py-1.5 border border-slate-700 rounded-lg transition">
                ‚Üª Refresh
            </button>
        </div>
    </div>

    <!-- Last updated -->
    <p class="text-xs text-slate-600 mt-3" id="last-updated-line">
        Last updated: {{ last_updated if last_updated else 'Pending first poll‚Ä¶' }}
    </p>

    <!-- Stats -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mt-3" id="stats-container">
        <div class="bg-slate-800 rounded-xl p-3">
            <p class="text-xs text-slate-500 mb-1">{{ 'Credits' if card.card_type == 'timezone' else 'Cash Balance' }}</p>
            <p class="font-bold text-green-400 text-xl" id="stat-balance">‚Äì</p>
        </div>
        <div class="bg-slate-800 rounded-xl p-3">
            <p class="text-xs text-slate-500 mb-1">Bonus</p>
            <p class="font-bold text-yellow-400 text-xl" id="stat-bonus">‚Äì</p>
        </div>
        <div class="bg-slate-800 rounded-xl p-3">
            <p class="text-xs text-slate-500 mb-1">{{ 'e-Tickets' if card.card_type == 'timezone' else 'Points' }}</p>
            <p class="font-bold text-{{ 'orange' if card.card_type == 'timezone' else 'purple' }}-400 text-xl" id="stat-points">‚Äì</p>
        </div>
        <div class="bg-slate-800 rounded-xl p-3">
            <p class="text-xs text-slate-500 mb-1" id="stat-spent-label">Spent (24h)</p>
            <p class="font-bold text-slate-400 text-xl" id="stat-spent">‚Äì</p>
        </div>
        <div class="bg-slate-800 rounded-xl p-3">
            <p class="text-xs text-slate-500 mb-1">All-Time Spent</p>
            <p class="font-bold text-slate-400 text-xl" id="stat-alltime">‚Äì</p>
        </div>
    </div>
</div>

<!-- Balance History Chart -->
<div class="card rounded-2xl p-5 mb-4">
    <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
        <h2 class="text-base font-bold text-white">Balance History</h2>
        <div class="flex gap-1 bg-slate-800 rounded-lg p-0.5">
            <button onclick="loadChart('day')" id="btn-day" class="period-btn active px-3 py-1.5 rounded-md text-xs font-medium transition">24h</button>
            <button onclick="loadChart('week')" id="btn-week" class="period-btn px-3 py-1.5 rounded-md text-xs font-medium transition">7 Days</button>
            <button onclick="loadChart('month')" id="btn-month" class="period-btn px-3 py-1.5 rounded-md text-xs font-medium transition">30 Days</button>
            <button onclick="loadChart('all')" id="btn-all" class="period-btn px-3 py-1.5 rounded-md text-xs font-medium transition">All Time</button>
        </div>
    </div>
    <div style="position:relative; height:280px;">
        <canvas id="balanceChart"></canvas>
        <div id="chart-loading" class="absolute inset-0 flex items-center justify-center text-slate-500 text-sm">
            <div class="flex items-center gap-2"><span class="animate-spin">‚ü≥</span> Loading...</div>
        </div>
        <div id="chart-empty" class="hidden absolute inset-0 flex flex-col items-center justify-center text-slate-600">
            <div class="text-3xl mb-2">üìä</div>
            <p class="text-sm">Not enough data yet</p>
            <p class="text-xs mt-1">Check back after more polls</p>
        </div>
    </div>
</div>

<!-- Points/Tickets History -->
<div class="card rounded-2xl p-5 mb-4">
    <h2 class="text-base font-bold text-white mb-4">{{ 'e-Ticket' if card.card_type == 'timezone' else 'Points' }} History</h2>
    <div style="position:relative; height:160px;">
        <canvas id="pointsChart"></canvas>
        <div id="points-loading" class="absolute inset-0 flex items-center justify-center text-slate-500 text-sm">
            <div class="flex items-center gap-2"><span class="animate-spin">‚ü≥</span> Loading...</div>
        </div>
        <div id="points-empty" class="hidden absolute inset-0 flex items-center justify-center text-slate-600 text-sm">No data yet</div>
    </div>
</div>

<!-- Transaction Log (Timezone only) -->
{% if card.card_type == 'timezone' %}
<div class="card rounded-2xl p-5 mb-4" id="tx-log-card">
    <div class="flex items-center justify-between mb-3">
        <h2 class="text-base font-bold text-white">üéÆ Game History</h2>
        <span class="text-xs text-slate-600" id="tx-log-count"></span>
    </div>

    <div class="overflow-y-auto rounded-lg border border-slate-700/50" style="max-height: 320px; background-color: #0f172a;">
        <table class="w-full">
            <thead class="sticky top-0 bg-slate-900 border-b border-slate-700">
                <tr>
                    <th class="py-3 px-4 text-left text-slate-400 text-xs font-semibold tracking-wide">Date</th>
                    <th class="py-3 px-4 text-left text-slate-400 text-xs font-semibold tracking-wide">Description</th>
                    <th class="py-3 px-4 text-right text-slate-400 text-xs font-semibold tracking-wide">Change</th>
                </tr>
            </thead>
            <tbody id="tap-history-body"></tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Poll Log -->
<div class="card rounded-2xl p-5">
    <h2 class="text-base font-bold text-white mb-3">üì° Last Pings</h2>
    <div id="poll-log-container">
    {% if poll_logs %}
    <div class="space-y-0" id="poll-log-list">
    {% for log in poll_logs %}
    <div class="flex items-center gap-3 text-xs py-1.5 border-b border-slate-800/50">
        <span class="{{ 'text-green-400' if log.success else 'text-red-400' }}">{{ '‚úì' if log.success else '‚úó' }}</span>
        <span class="text-slate-600 font-mono w-32 shrink-0">{{ log.logged_at[:16] }}</span>
        <span class="text-slate-500">{{ log.message or 'OK' }}</span>
    </div>
    {% endfor %}
    </div>
    {% else %}
    <p class="text-slate-600 text-sm" id="poll-log-empty">No polls yet.</p>
    {% endif %}
    </div>
</div>

<style>
.period-btn { color: #64748b; }
.period-btn.active { background: #4f46e5; color: white; }
.period-btn:hover:not(.active) { color: #e2e8f0; }

/* Table styling */
table { width: 100%; border-collapse: collapse; }

/* Scrollbar styling */
.overflow-y-auto::-webkit-scrollbar { width: 6px; }
.overflow-y-auto::-webkit-scrollbar-track { background: #0f172a; }
.overflow-y-auto::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
.overflow-y-auto::-webkit-scrollbar-thumb:hover { background: #475569; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script>
const CARD_ID = {{ card.id }};
const USER_TZ = '{{ user_timezone }}';
let balanceChart, pointsChart;

const chartOpts = {
    responsive: true, maintainAspectRatio: false, animation: { duration: 300 },
    plugins: {
        legend: { labels: { color: '#64748b', boxWidth: 10, font: { size: 11 } } },
        tooltip: { backgroundColor: '#1e293b', borderColor: '#334155', borderWidth: 1, titleColor: '#e2e8f0', bodyColor: '#94a3b8' }
    },
    scales: {
        x: { ticks: { color: '#475569', maxTicksLimit: 8, font: { size: 10 } }, grid: { color: '#1e293b' } },
        y: { ticks: { color: '#475569', font: { size: 10 } }, grid: { color: '#1e293b' } }
    }
};

function formatLabel(ts) {
    const d = new Date(ts.replace(' ','T') + 'Z');
    return d.toLocaleString('en-AU', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', timeZone: USER_TZ });
}

function formatDateForHistory(ts) {
    if (!ts) return '‚Äì';
    try {
        const d = new Date(ts);
        if (isNaN(d.getTime())) return '‚Äì';
        return d.toLocaleString('en-AU', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', timeZone: USER_TZ });
    } catch(e) {
        console.error('Date format error:', ts, e);
        return '‚Äì';
    }
}

async function loadStats() {
    try {
        const r = await fetch(`/api/cards/${CARD_ID}/stats`);
        const d = await r.json();

        if (d.latest) {
            document.getElementById('stat-balance').textContent = '$' + (d.latest.cash_balance || 0).toFixed(2);
            document.getElementById('stat-bonus').textContent   = '$' + (d.latest.cash_bonus || 0).toFixed(2);
            document.getElementById('stat-points').textContent  = (d.latest.points || 0).toLocaleString();
        }

        if (d.spent_alltime !== null && d.spent_alltime !== undefined) {
            const spent = d.spent_alltime;
            const el = document.getElementById('stat-alltime');
            el.textContent = (spent > 0 ? '-$' : '+$') + Math.abs(spent).toFixed(2);
            el.className = 'font-bold text-xl ' + (spent > 0 ? 'text-red-400' : 'text-green-400');
        }

        // Timezone: render imported transaction history table
        const tbody = document.getElementById('tap-history-body');
        const countEl = document.getElementById('tx-log-count');
        if (tbody) {
            if (d.history && d.history.length) {
                if (countEl) countEl.textContent = d.history.length + ' transactions';
                tbody.innerHTML = d.history.map(h => {
                    const delta = (h.bonusBalance || 0) + (h.cashBalance || 0);
                    const cls = delta < 0 ? 'text-red-400' : 'text-green-400';
                    const sign = delta > 0 ? '+' : '';
                    return `
                        <tr class="border-b border-slate-800/50 hover:bg-slate-900/50 transition">
                            <td class="py-3 px-4 text-slate-300 text-xs font-mono">${formatDateForHistory(h.modified)}</td>
                            <td class="py-3 px-4 text-slate-300 text-xs">${h.description || 'Recharge'}</td>
                            <td class="py-3 px-4 text-right text-xs ${cls} font-semibold">${sign}${delta.toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');
            } else {
                if (countEl) countEl.textContent = '';
                tbody.innerHTML = '<tr><td colspan="3" class="py-4 px-4 text-center text-slate-600 text-sm">No activity yet.</td></tr>';
            }
        }
    } catch(e) { console.error('Stats error:', e); }
}

async function loadChart(period = 'day') {
    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`btn-${period}`).classList.add('active');
    document.getElementById('chart-loading').classList.remove('hidden');
    document.getElementById('chart-empty').classList.add('hidden');
    document.getElementById('points-loading').classList.remove('hidden');
    document.getElementById('points-empty').classList.add('hidden');

    // Update spent label to match period
    const periodLabels = {day: '24h', week: '7d', month: '30d', all: 'All Time'};
    const spentLabel = document.getElementById('stat-spent-label');
    if (spentLabel) spentLabel.textContent = `Spent (${periodLabels[period] || '24h'})`;

    try {
        const r = await fetch(`/api/cards/${CARD_ID}/history?period=${period}`);
        const d = await r.json();

        document.getElementById('chart-loading').classList.add('hidden');
        document.getElementById('points-loading').classList.add('hidden');

        if (!d.labels || d.labels.length < 2) {
            document.getElementById('chart-empty').classList.remove('hidden');
            document.getElementById('points-empty').classList.remove('hidden');
            // Clear spent for this period if no data
            const spentEl = document.getElementById('stat-spent');
            spentEl.textContent = '‚Äì';
            spentEl.className = 'font-bold text-slate-400 text-xl';
            return;
        }

        // Calculate spent from chart data (first total vs last total)
        const balData = d.cash_balance || [];
        const bonData = d.cash_bonus || [];
        if (balData.length >= 2) {
            const firstTotal = (balData[0] || 0) + (bonData[0] || 0);
            const lastTotal  = (balData[balData.length-1] || 0) + (bonData[bonData.length-1] || 0);
            const spent = firstTotal - lastTotal;
            const spentEl = document.getElementById('stat-spent');
            spentEl.textContent = (spent > 0 ? '-$' : '+$') + Math.abs(spent).toFixed(2);
            spentEl.className = 'font-bold text-xl ' + (spent > 0 ? 'text-red-400' : 'text-green-400');
        }

        const labels = d.labels.map(formatLabel);
        const pts = d.labels.length > 100 ? 0 : d.labels.length > 50 ? 1 : 3;
        const descriptions = d.descriptions || [];

        const tooltipPlugin = {
            ...chartOpts.plugins.tooltip,
            callbacks: {
                label: ctx => {
                    const val = '$' + (ctx.parsed.y || 0).toFixed(2);
                    const desc = descriptions[ctx.dataIndex];
                    return desc ? `${ctx.dataset.label}: ${val} ‚Äî ${desc}` : `${ctx.dataset.label}: ${val}`;
                }
            }
        };

        if (balanceChart) balanceChart.destroy();
        balanceChart = new Chart(document.getElementById('balanceChart').getContext('2d'), {
            type: 'line',
            data: { labels, datasets: [
                { label: 'Balance', data: d.cash_balance, borderColor: '#4ade80', backgroundColor: 'rgba(74,222,128,0.06)', fill: true, tension: 0.3, pointRadius: pts, borderWidth: 2 },
                { label: 'Bonus',   data: d.cash_bonus,   borderColor: '#facc15', backgroundColor: 'rgba(250,204,21,0.06)', fill: true, tension: 0.3, pointRadius: pts, borderWidth: 2 }
            ]},
            options: { ...chartOpts, plugins: { ...chartOpts.plugins, tooltip: tooltipPlugin },
                scales: { ...chartOpts.scales,
                    y: { ...chartOpts.scales.y, ticks: { ...chartOpts.scales.y.ticks, callback: v => '$'+(v||0).toFixed(2) } }
                }
            }
        });

        if (pointsChart) pointsChart.destroy();
        pointsChart = new Chart(document.getElementById('pointsChart').getContext('2d'), {
            type: 'line',
            data: { labels, datasets: [
                { label: '{{ "e-Tickets" if card.card_type == "timezone" else "Points" }}',
                  data: d.points,
                  borderColor: '#{{ "fb923c" if card.card_type == "timezone" else "c084fc" }}',
                  backgroundColor: 'rgba(192,132,252,0.06)',
                  fill: true, tension: 0.3, pointRadius: pts, borderWidth: 2
                }
            ]},
            options: chartOpts
        });
    } catch(e) { console.error('Chart error:', e); }
}

// ‚îÄ‚îÄ Timezone token re-auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function tzReauth(btn) {
    const orig = btn.textContent;
    btn.textContent = '‚ü≥ Refreshing...'; btn.disabled = true;
    try {
        const r = await fetch('/api/timezone/reauth', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: '{}'
        });
        const d = await r.json();
        if (d.success) {
            btn.textContent = '‚úÖ Refreshed!';
            btn.className = btn.className
                .replace('text-yellow-500', 'text-green-400')
                .replace('border-yellow-800/50', 'border-green-800/50');
            setTimeout(() => location.reload(), 1200);
        } else {
            btn.textContent = '‚ùå Failed';
            const container = document.getElementById('poll-log-container');
            if (container) {
                const errDiv = document.createElement('div');
                errDiv.className = 'text-xs text-red-400 mt-2 p-2 bg-red-900/20 border border-red-900 rounded-lg';
                errDiv.textContent = '‚úó Token refresh failed ‚Äî reconnect via bookmarklet in Settings';
                container.prepend(errDiv);
                setTimeout(() => errDiv.remove(), 6000);
            }
            setTimeout(() => { btn.textContent = orig; btn.disabled = false; }, 3000);
        }
    } catch(e) { btn.textContent = orig; btn.disabled = false; }
}

// ‚îÄ‚îÄ Force poll ‚Äî updates stats, chart, poll log and timestamp ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function forcePoll() {
    const btn = document.getElementById('poll-btn');
    btn.textContent = '‚ü≥ Polling‚Ä¶'; btn.disabled = true;

    try {
        const r = await fetch(`/cards/${CARD_ID}/force-poll`, { method: 'POST' });
        const result = await r.json();

        if (result.success) {
            btn.textContent = '‚úì Updated';

            if (result.data) {
                const d = result.data;
                document.getElementById('stat-balance').textContent = '$' + (d.cash_balance || 0).toFixed(2);
                document.getElementById('stat-bonus').textContent   = '$' + (d.cash_bonus || 0).toFixed(2);
                document.getElementById('stat-points').textContent  = (d.points || 0).toLocaleString();
            }

            if (result.last_updated) {
                try {
                    const d = new Date(result.last_updated.replace(' ','T') + 'Z');
                    if (!isNaN(d.getTime())) {
                        document.getElementById('last-updated-line').textContent = 'Last updated: ' + d.toLocaleString('en-AU', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', timeZone: USER_TZ });
                    } else {
                        document.getElementById('last-updated-line').textContent = 'Last updated: ' + result.last_updated;
                    }
                } catch(e) {
                    document.getElementById('last-updated-line').textContent = 'Last updated: ' + result.last_updated;
                }
            }

            if (result.logs && result.logs.length) {
                const list = document.getElementById('poll-log-list') || (() => {
                    const container = document.getElementById('poll-log-container');
                    container.innerHTML = '<div class="space-y-0" id="poll-log-list"></div>';
                    return document.getElementById('poll-log-list');
                })();

                list.innerHTML = result.logs.map(l => {
                    let logTs = l.logged_at;
                    try {
                        const d = new Date(l.logged_at.replace(' ','T') + 'Z');
                        if (!isNaN(d.getTime())) logTs = d.toLocaleString('en-AU', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', timeZone: USER_TZ });
                    } catch(e) {}
                    return `<div class="flex items-center gap-3 text-xs py-1.5 border-b border-slate-800/50">
                        <span class="${l.success ? 'text-green-400' : 'text-red-400'}">${l.success ? '‚úì' : '‚úó'}</span>
                        <span class="text-slate-600 font-mono w-32 shrink-0">${logTs}</span>
                        <span class="text-slate-500">${l.message}</span>
                    </div>`;
                }).join('');
            }

            setTimeout(() => {
                const active = document.querySelector('.period-btn.active');
                loadChart(active ? active.id.replace('btn-','') : 'day');
                loadStats();
            }, 400);

        } else {
            btn.textContent = '‚úó Failed';
            const container = document.getElementById('poll-log-container');
            const errDiv = document.createElement('div');
            errDiv.className = 'text-xs text-red-400 mt-2 p-2 bg-red-900/20 border border-red-900 rounded-lg';
            errDiv.textContent = '‚úó ' + (result.error || 'Unknown error');
            container.prepend(errDiv);
            setTimeout(() => errDiv.remove(), 5000);
        }
    } catch(e) {
        btn.textContent = '‚úó Error';
        console.error(e);
    }

    setTimeout(() => { btn.textContent = '‚Üª Refresh'; btn.disabled = false; }, 2500);
}

// ‚îÄ‚îÄ Card rename ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startRename() {
    document.getElementById('card-title').classList.add('hidden');
    document.getElementById('rename-btn').classList.add('hidden');
    document.getElementById('rename-input').classList.remove('hidden');
    document.getElementById('rename-actions').classList.remove('hidden');
    document.getElementById('rename-input').focus();
    document.getElementById('rename-input').select();
}
function cancelRename() {
    document.getElementById('card-title').classList.remove('hidden');
    document.getElementById('rename-btn').classList.remove('hidden');
    document.getElementById('rename-input').classList.add('hidden');
    document.getElementById('rename-actions').classList.add('hidden');
}
async function saveRename() {
    const newLabel = document.getElementById('rename-input').value.trim();
    if (!newLabel) return;
    const form = new FormData();
    form.append('card_label', newLabel);
    const r = await fetch(`/cards/${CARD_ID}/rename`, { method: 'POST', body: form });
    const result = await r.json();
    if (result.success) {
        document.getElementById('card-title').textContent = result.label;
        document.getElementById('breadcrumb-label').textContent = result.label;
        document.title = result.label + ' ‚Äì Balance Tracker';
        cancelRename();
    }
}

async function importHistory() {
    const btn = document.getElementById('import-btn');
    if (!btn) return;
    btn.textContent = '‚ü≥ Importing‚Ä¶'; btn.disabled = true;

    try {
        const r = await fetch(`/api/cards/${CARD_ID}/import-transactions`, { method: 'POST' });
        const result = await r.json();

        if (result.success) {
            btn.textContent = `‚úì ${result.imported} imported`;
            if (result.imported > 0) {
                setTimeout(() => {
                    loadChart(document.querySelector('.period-btn.active')?.id.replace('btn-','') || 'day');
                    loadStats();
                }, 500);
            }
        } else {
            btn.textContent = '‚úó ' + (result.error || 'Failed');
        }
    } catch(e) {
        btn.textContent = '‚úó Error';
    }

    setTimeout(() => { btn.textContent = '‚¨á Import History'; btn.disabled = false; }, 3000);
}

loadStats();
loadChart('day');

// Convert last-updated timestamp to user timezone
(function() {
    const el = document.getElementById('last-updated-line');
    const raw = el.textContent.replace('Last updated: ', '').trim();
    if (raw && raw !== 'Pending first poll‚Ä¶') {
        try {
            const d = new Date(raw.replace(' ','T') + 'Z');
            if (!isNaN(d.getTime())) {
                el.textContent = 'Last updated: ' + d.toLocaleString('en-AU', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', timeZone: USER_TZ });
            }
        } catch(e) {}
    }
    // Convert all server-rendered poll log timestamps
    document.querySelectorAll('#poll-log-list .font-mono.w-32').forEach(span => {
        const raw = span.textContent.trim();
        if (raw) {
            try {
                const d = new Date(raw.replace(' ','T') + 'Z');
                if (!isNaN(d.getTime())) {
                    span.textContent = d.toLocaleString('en-AU', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', timeZone: USER_TZ });
                }
            } catch(e) {}
        }
    });
})();

setInterval(() => {
    loadStats();
    const a = document.querySelector('.period-btn.active');
    if (a) loadChart(a.id.replace('btn-',''));
}, 60000);
</script>

{% endblock %}