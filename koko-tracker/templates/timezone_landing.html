{% extends "base.html" %}
{% block title %}Connecting Timezone ‚Äì Koko Tracker{% endblock %}
{% block content %}

<div class="max-w-md mx-auto mt-8">
    <div class="card rounded-2xl p-8 text-center">

        <div id="state-loading">
            <div class="text-5xl mb-4">üîê</div>
            <h2 class="text-xl font-bold text-white mb-2">Capturing your session...</h2>
            <p class="text-slate-400 text-sm mb-6">Just a moment</p>
            <div class="flex justify-center">
                <div class="w-8 h-8 border-2 border-indigo-400 border-t-transparent rounded-full animate-spin"></div>
            </div>
        </div>

        <div id="state-success" class="hidden">
            <div class="text-5xl mb-4">‚úÖ</div>
            <h2 class="text-xl font-bold text-white mb-2">Connected!</h2>
            <p class="text-slate-400 text-sm mb-4" id="success-msg"></p>
            <div id="card-list" class="space-y-3 text-left mb-6"></div>
            <a href="/dashboard" class="block w-full btn-primary py-3 rounded-xl text-white font-medium">
                Go to Dashboard ‚Üí
            </a>
        </div>

        <div id="state-error" class="hidden">
            <div class="text-5xl mb-4">‚ùå</div>
            <h2 class="text-xl font-bold text-white mb-2">Something went wrong</h2>
            <p id="error-msg" class="text-slate-400 text-sm mb-6"></p>
            <a href="/timezone/start" class="block w-full btn-primary py-3 rounded-xl text-white font-medium mb-3">Try again</a>
            <a href="/dashboard" class="text-sm text-slate-500 hover:text-slate-300">Skip for now</a>
        </div>

    </div>
</div>

<script>
function showState(name, msg) {
    ['loading','success','error'].forEach(s =>
        document.getElementById(`state-${s}`).classList.add('hidden'));
    document.getElementById(`state-${name}`).classList.remove('hidden');
    if (msg) {
        const el = document.getElementById(name === 'error' ? 'error-msg' : 'success-msg');
        if (el) el.textContent = msg;
    }
}

function renderCards(cards, name) {
    const list = document.getElementById('card-list');
    showState('success', `Connected as ${name}! Found ${cards.length} card(s):`);
    if (!cards.length) {
        showState('success', `Connected as ${name}! No cards found on this account.`);
        return;
    }
    list.innerHTML = cards.map(card => `
        <div class="bg-slate-800 rounded-xl p-4">
            <div class="flex items-start justify-between gap-3 mb-3">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <div class="font-mono font-bold text-white text-lg">${card.number}</div>
                        ${card.tier ? `<span class="text-xs px-2 py-0.5 rounded-full font-medium ${
                            card.tier === 'Platinum' ? 'bg-purple-900/60 text-purple-300 border border-purple-700' :
                            card.tier === 'Gold' ? 'bg-yellow-900/60 text-yellow-300 border border-yellow-700' :
                            card.tier === 'Silver' ? 'bg-slate-600 text-slate-300 border border-slate-500' :
                            'bg-orange-900/60 text-orange-300 border border-orange-700'
                        }">${card.tier}</span>` : ''}
                        ${card.status ? `<span class="text-xs px-2 py-0.5 rounded-full bg-green-900/50 text-green-400 border border-green-800">${card.status}</span>` : ''}
                    </div>
                    <div class="text-xs text-slate-500 font-mono">${card.fullCardNumber || ''}</div>
                </div>
                <span class="text-slate-500 text-xs">${card.country}</span>
            </div>
            <div class="grid grid-cols-3 gap-2 mb-3">
                <div class="bg-slate-900 rounded-lg p-2 text-center">
                    <div class="text-xs text-slate-500 mb-0.5">Credits</div>
                    <div class="font-bold text-green-400 text-sm">$${card.cashBalance.toFixed(2)}</div>
                </div>
                <div class="bg-slate-900 rounded-lg p-2 text-center">
                    <div class="text-xs text-slate-500 mb-0.5">Bonus</div>
                    <div class="font-bold text-yellow-400 text-sm">$${card.bonusBalance.toFixed(2)}</div>
                </div>
                <div class="bg-slate-900 rounded-lg p-2 text-center">
                    <div class="text-xs text-slate-500 mb-0.5">e-Tickets</div>
                    <div class="font-bold text-orange-400 text-sm">${card.tickets}</div>
                </div>
            </div>
            <form method="POST" action="/timezone/add-card">
                <input type="hidden" name="card_number" value="${card.number}">
                <input type="hidden" name="cash_balance" value="${card.cashBalance}">
                <input type="hidden" name="bonus_balance" value="${card.bonusBalance}">
                <input type="hidden" name="tickets" value="${card.tickets}">
                <input type="hidden" name="tier" value="${card.tier || ''}">
                <input type="hidden" name="card_label" value="Timezone ${card.number}">
                <button type="submit" class="w-full btn-primary py-2.5 rounded-lg text-sm font-medium text-white">+ Track this card</button>
            </form>
        </div>
    `).join('');
}

async function run() {
    // ‚îÄ‚îÄ Check if this is an OAuth success redirect ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {% if oauth_success is defined and oauth_success %}
    const oauthCards = {{ oauth_cards | tojson }};
    const oauthName = {{ oauth_name | tojson }};
    renderCards(oauthCards, oauthName);
    return;
    {% endif %}

    // ‚îÄ‚îÄ Token comes from URL ?token= param (injected by bookmarklet) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    const refreshToken = params.get('refresh_token');
    const clientId = params.get('client_id');

    if (!token || !token.startsWith('eyJ')) {
        showState('error', 'No token received. Please go back and follow the steps ‚Äî make sure you paste the code into the Timezone portal address bar while logged in.');
        return;
    }

    // Clean token from URL (don't expose in history)
    window.history.replaceState({}, '', '/timezone/landing');

    try {
        const resp = await fetch('/timezone/extract-token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bearer_token: token, cookies: {}, refresh_token: refreshToken, client_id: clientId })
        });
        const result = await resp.json();
        if (result.success) {
            renderCards(result.cards, result.name);
        } else {
            showState('error', result.error || 'Session validation failed. Please try logging in again.');
        }
    } catch(e) {
        showState('error', 'Network error: ' + e.message);
    }
}

run();
</script>
{% endblock %}
