{% extends "base.html" %}
{% block title %}Connecting Timezone ‚Äì Koko Tracker{% endblock %}
{% block content %}

<div class="max-w-md mx-auto mt-8">
    <div class="card rounded-2xl p-8 text-center">

        <div id="state-loading">
            <div class="text-5xl mb-4">üîê</div>
            <h2 class="text-xl font-bold text-white mb-2">Capturing your session...</h2>
            <p class="text-slate-400 text-sm mb-6">Just a moment</p>
            <div class="flex justify-center">
                <div class="w-8 h-8 border-2 border-indigo-400 border-t-transparent rounded-full animate-spin"></div>
            </div>
        </div>

        <div id="state-success" class="hidden">
            <div class="text-5xl mb-4">‚úÖ</div>
            <h2 class="text-xl font-bold text-white mb-2">Connected!</h2>
            <p class="text-slate-400 text-sm mb-4" id="success-msg"></p>
            <div id="card-list" class="space-y-3 text-left mb-6"></div>
            <a href="/dashboard" class="block w-full btn-primary py-3 rounded-xl text-white font-medium">
                Go to Dashboard ‚Üí
            </a>
        </div>

        <div id="state-error" class="hidden">
            <div class="text-5xl mb-4">‚ùå</div>
            <h2 class="text-xl font-bold text-white mb-2">Something went wrong</h2>
            <p id="error-msg" class="text-slate-400 text-sm mb-6"></p>
            <a href="/timezone/start" class="block w-full btn-primary py-3 rounded-xl text-white font-medium mb-3">Try again</a>
            <a href="/dashboard" class="text-sm text-slate-500 hover:text-slate-300">Skip for now</a>
        </div>

    </div>
</div>

<script>
function showState(name, msg) {
    ['loading','success','error'].forEach(s =>
        document.getElementById(`state-${s}`).classList.add('hidden'));
    document.getElementById(`state-${name}`).classList.remove('hidden');
    if (msg) {
        const el = document.getElementById(name === 'error' ? 'error-msg' : 'success-msg');
        if (el) el.textContent = msg;
    }
}

function renderCards(cards, name) {
    const list = document.getElementById('card-list');
    showState('success', `Connected as ${name}! Found ${cards.length} card(s):`);
    if (!cards.length) {
        showState('success', `Connected as ${name}! No cards found on this account.`);
        return;
    }
    list.innerHTML = cards.map(card => `
        <div class="bg-slate-800 rounded-xl p-4 flex items-center justify-between gap-3">
            <div>
                <div class="font-mono font-bold text-white">${card.number}</div>
                <div class="text-sm mt-1 flex gap-2 flex-wrap">
                    <span class="text-green-400">$${(card.cashBalance + card.bonusBalance).toFixed(2)}</span>
                    <span class="text-orange-400">üé´ ${card.tickets}</span>
                    <span class="text-slate-500 text-xs">${card.country}</span>
                </div>
            </div>
            <form method="POST" action="/timezone/add-card">
                <input type="hidden" name="card_number" value="${card.number}">
                <input type="hidden" name="cash_balance" value="${card.cashBalance}">
                <input type="hidden" name="bonus_balance" value="${card.bonusBalance}">
                <input type="hidden" name="tickets" value="${card.tickets}">
                <input type="hidden" name="card_label" value="Timezone ${card.number}">
                <button type="submit" class="btn-primary px-4 py-2 rounded-lg text-sm font-medium text-white">+ Track</button>
            </form>
        </div>
    `).join('');
}

async function run() {
    // ‚îÄ‚îÄ Token comes from URL ?token= param (injected by bookmarklet) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');

    if (!token || !token.startsWith('eyJ')) {
        showState('error', 'No token received. Please go back and follow the steps ‚Äî make sure you paste the code into the Timezone portal address bar while logged in.');
        return;
    }

    // Clean token from URL (don't expose in history)
    window.history.replaceState({}, '', '/timezone/landing');

    try {
        const resp = await fetch('/timezone/extract-token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bearer_token: token, cookies: {} })
        });
        const result = await resp.json();
        if (result.success) {
            renderCards(result.cards, result.name);
        } else {
            showState('error', result.error || 'Session validation failed. Please try logging in again.');
        }
    } catch(e) {
        showState('error', 'Network error: ' + e.message);
    }
}

run();
</script>
{% endblock %}
